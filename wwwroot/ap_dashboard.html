<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netinfo - AP Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #4D148C, #FF6600);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.8rem;
            color: #FFD700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 3px;
            text-transform: uppercase;
        }


        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Stats Section */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            border-color: #FFD700;
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #4D148C;
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }
		
		.stat-icon,
.stat-icon i {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: geometricPrecision;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    transform: translateZ(0);     /* “GPU’ya kahve” etkisi: keskinlik artar */
}

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 1px;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        /* Charts Section */
.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
}


        .chart-container {
    background: rgba(255, 255, 255, 0.12);
    border-radius: 20px;
    padding: 25px 20px;
    backdrop-filter: blur(12px);
    border: 2px solid rgba(255, 215, 0, 0.3);
    height: 420px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
}

        .chart-title {
    font-size: 1.6rem;
    font-weight: 700;
    color: #FFD700;
    margin-bottom: 18px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-shrink: 0;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
}

        .chart-wrapper {
    flex: 1;
    position: relative;
    min-height: 0;
}
.chart-wrapper canvas {
    position: absolute !important;
    top: 0;
    left: 0;
    width: 100% !important;
    height: 100% !important;
}
		
		.chart-card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.chart-card h3 {
  font-size: 1rem;
  margin-bottom: 10px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.chart-card canvas {
  width: 100% !important;
  height: 350px !important;
}


        /* AP List Section */
        .ap-list-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .search-controls {
    display: grid;
    grid-template-columns: 2fr 3fr auto;
    gap: 15px;
    margin-bottom: 25px;
    align-items: center;
}

        .search-input {
    flex: 1;
    padding: 12px 20px;
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 1rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: #FFD700;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
}

.search-input::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.filters-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
    white-space: nowrap;
}

.filter-select {
    padding: 8px 12px;
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 15px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 0.9rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    cursor: pointer;
    min-width: 140px;
}

.filter-select:focus {
    outline: none;
    border-color: #FFD700;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
}

.filter-select option {
    background: #4D148C;
    color: #fff;
    padding: 8px;
}

.refresh-btn {
    padding: 12px 20px;
    border: none;
    border-radius: 25px;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #4D148C;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.refresh-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
}

.filter-icon-btn {
    width: 40px;
    height: 40px;
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}

.filter-icon-btn:hover {
    background: rgba(255, 215, 0, 0.2);
    border-color: #FFD700;
    color: #FFD700;
    transform: translateY(-2px);
}

.filter-icon-btn.active {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    border-color: #FFD700;
    color: #4D148C;
}

.filters-panel {
    margin-top: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    border: 1px solid rgba(255, 215, 0, 0.2);
    transition: all 0.3s ease;
}

.filters-panel .filters-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-select {
    padding: 10px 15px;
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 0.9rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    cursor: pointer;
}

.filter-select:focus {
    outline: none;
    border-color: #FFD700;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
}

.filter-select option {
    background: #4D148C;
    color: #fff;
    padding: 5px;
}

        .filter-btn:hover, .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
        }

        .ap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .ap-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

        .ap-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: #FFD700;
        }

        .ap-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

        .ap-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #FFD700;
        }

        .ap-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-left: auto;
    max-width: fit-content;
}

        .status-online {
            background: linear-gradient(135deg, #10B981, #059669);
            color: #fff;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .status-offline {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: #fff;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .ap-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }

        .detail-value {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .client-count-badge {
    display: inline-block;
    background: linear-gradient(135deg, #10B981, #059669);
    color: #fff;
    border-radius: 15px;
    padding: 4px 8px;
    font-size: 0.7rem;
    font-weight: 700;
    margin-left: 10px;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    vertical-align: middle;
}

@keyframes pulse {
    0% { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
    50% { box-shadow: 0 4px 20px rgba(16, 185, 129, 0.8); }
    100% { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
}

.controls-wrapper {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 25px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.search-row {
    display: flex;
    gap: 15px;
    align-items: center;
}

.filter-icons {
    display: flex;
    gap: 8px;
}

.ap-summary-bar {
    background: rgba(255, 215, 0, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-around;
    text-align: center;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    padding: 15px 0;
    border-top: 1px solid rgba(255, 215, 0, 0.2);
    flex-wrap: wrap;
}

.summary-item {
    text-align: center;
    flex: 1;
    min-width: 100px;
}

.summary-number {
    font-size: 1.4rem;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.summary-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

@media (max-width: 768px) {
    .filters-row {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    
    .filter-group {
        justify-content: space-between;
    }
    
    .filter-select {
        min-width: auto;
        flex: 1;
    }
}

        /* Client Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4D148C, #FF6600);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            border: 2px solid rgba(255, 215, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #FFD700;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: #FFD700;
            font-size: 2rem;
            cursor: pointer;
            padding: 5px;
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .clients-table th {
            background: rgba(255, 215, 0, 0.3);
            color: #FFD700;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 215, 0, 0.5);
        }

        .clients-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .clients-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
		
.vlan-capacity {
    margin: 12px 0;
    padding: 12px 15px;
    border-radius: 12px;
    font-size: 0.85rem;
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.vlan-capacity.safe {
    border-left: 4px solid #10B981;
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), rgba(0, 0, 0, 0.2));
}

.vlan-capacity.warning {
    border-left: 4px solid #F59E0B;
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), rgba(0, 0, 0, 0.2));
}

.vlan-capacity.danger {
    border-left: 4px solid #EF4444;
    background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), rgba(0, 0, 0, 0.2));
}

.capacity-bar {
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    margin: 8px 0;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
}

.capacity-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease;
    background: linear-gradient(90deg, #10B981 0%, #F59E0B 70%, #EF4444 100%);
    box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
}

.capacity-text {
    color: #FFD700;
    font-weight: 600;
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.capacity-main {
    font-size: 0.9rem;
}

.capacity-this-ap {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.7);
    background: rgba(255, 215, 0, 0.1);
    padding: 2px 6px;
    border-radius: 8px;
}

.subnet-info {
    color: rgba(255, 255, 255, 0.6);
    font-family: 'Courier New', monospace;
    font-size: 0.7rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
}

.subnet-address {
    background: rgba(255, 255, 255, 0.05);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
}

.vlan-info {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
		
		/* Signal Summary Cards */
.signal-summary-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.signal-summary-card h4 {
    margin: 0 0 8px 0;
    font-size: 1rem;
    color: #FFD700;
}

.signal-summary-card .signal-count {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.signal-summary-card .signal-range {
    font-size: 0.8rem;
    opacity: 0.8;
}

        .signal-strength {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .signal-bar {
            width: 60px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .signal-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .signal-excellent { 
            background: linear-gradient(90deg, #10B981, #059669); 
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .signal-good { 
            background: linear-gradient(90deg, #22C55E, #16A34A); 
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        .signal-fair { 
            background: linear-gradient(90deg, #F59E0B, #D97706); 
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .signal-poor { 
            background: linear-gradient(90deg, #EF4444, #DC2626); 
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FFA500, #FF6600);
        }

        .last-update {
            text-align: center;
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-section {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto;
            }
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .search-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .ap-grid {
                grid-template-columns: 1fr;
            }
        }
		
		.ssid-leaderboard {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px 0;
    flex: 1;
}

.ssid-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    padding: 10px 0;
    flex: 1;
}

.ssid-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px 15px;
    text-align: center;
    border: 2px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ssid-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.6s ease;
}

.ssid-card:hover::before {
    left: 100%;
}

.ssid-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
}



.ssid-client-count {
    font-size: 2.2rem;
    font-weight: 800;
    margin-bottom: 8px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 5px 10px;
    display: inline-block;
}

.ssid-percentage {
    font-size: 1rem;
    font-weight: 600;
    color: #FFD700;
    margin-bottom: 15px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 3px 8px;
    display: inline-block;
}

.ssid-name {
    font-size: 1rem;
    font-weight: 600;
    color: #FFD700;
    margin-bottom: 15px;
    letter-spacing: 1px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
}

/* Flip card için stat-card'ı override et */
.stat-card.flip-card {
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
    backdrop-filter: none !important;
}

/* Flip card hover efektleri de düzelt */
.stat-card.flip-card:hover {
    transform: none !important;
    box-shadow: none !important;
    border-color: transparent !important;
}

.stat-card.flip-card::before {
    display: none !important;
}

/* Flip card front ve back için düzgün stil */
.flip-card-front, .flip-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 20px;
    padding: 30px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-sizing: border-box;
    transition: all 0.4s ease;
}

/* Stat icon'ları düzelt */
.flip-card-front .stat-icon,
.flip-card-back .stat-icon {
    width: 70px;
    height: 70px;
    margin: 0 auto 15px;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: #4D148C;
    box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
    flex-shrink: 0;
}

/* Stat değerleri */
.flip-card-front .stat-value,
.flip-card-back .stat-value {
    font-size: 1.8rem; /* 2.5rem'den küçülttük */
    font-weight: 700;
    color: #FFD700;
    margin-bottom: 10px;
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    line-height: 1;
    word-break: break-word; /* Uzun hostname'ler için */
}

/* Stat label'ları */
.flip-card-front .stat-label,
.flip-card-back .stat-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1rem;
    font-weight: 500;
    letter-spacing: 1px;
    text-align: center;
    margin-top: auto;
}

.flip-card:hover .flip-card-front,
.flip-card:hover .flip-card-back {
    /* transform: translateY(-5px);  <-- SİL */
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    border-color: #FFD700;
}

.ssid-icon {
    width: 40px;
    height: 40px;
    margin: 0 auto;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: #fff;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.flip-card {
    position: relative;
    min-height: 220px;
    width: 100%;
    perspective: 1200px;              /* 1000 -> 1200: daha doğal derinlik */
    perspective-origin: 50% 50%;
    isolation: isolate;               /* yeni: kendi boyama bağlamı */
}

.flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 600ms cubic-bezier(0.22, 1, 0.36, 1); /* daha pürüzsüz easing */
    transform-style: preserve-3d;
    -webkit-transform-style: preserve-3d;
    will-change: transform;           /* GPU katmanı */
}

.flip-card-inner.flipped {
    transform: rotateY(180deg);
}

.flip-card-front, .flip-card-back {
    inset: 0;                         /* top/left/right/bottom:0 eşdeğeri */
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    transform: translateZ(0);         /* katman terfisi + alt-piksel titremeyi azaltır */
    will-change: transform, opacity;
    /* İsteğe bağlı: blur ağır geliyorsa 15px -> 8px yapabilirsin */
    /* backdrop-filter: blur(8px); */
}

.flip-card-back .stat-icon { 
  display: none !important; 
}

.flip-card-back { 
  justify-content: center; 
}
.flip-card-back .breakdown-stats { 
  margin-top: 6px; 
}
.flip-card-back .stat-label { 
  margin-top: 8px; 
}

/* ARKA YÜZ dönüşü aynı kalsın */
.flip-card-back { transform: rotateY(180deg); }

.breakdown-stats {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin: 10px 0;
    width: 100%;
    max-width: 200px;
}

.breakdown-item {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.1);
    padding: 4px 8px;
    border-radius: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0; /* Flexbox için önemli */
}

/* Özel kart renkleri - front ve back için ayrı ayrı */
.critical-subnet-card .flip-card-front,
.critical-subnet-card .flip-card-back {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(255, 255, 255, 0.1));
    border: 2px solid rgba(239, 68, 68, 0.4);
}

.critical-subnet-card.warning .flip-card-front,
.critical-subnet-card.warning .flip-card-back {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(255, 255, 255, 0.1));
    border: 2px solid rgba(245, 158, 11, 0.4);
}

.critical-subnet-card.safe .flip-card-front,
.critical-subnet-card.safe .flip-card-back {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(255, 255, 255, 0.1));
    border: 2px solid rgba(16, 185, 129, 0.4);
}

.performance-card .flip-card-front,
.performance-card .flip-card-back {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(255, 255, 255, 0.1));
    border: 2px solid rgba(59, 130, 246, 0.4);
}

.critical-icon {
    animation: pulse-warning 2s infinite;
}

@keyframes pulse-warning {
    0% { box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 10px 35px rgba(239, 68, 68, 0.8); }
    100% { box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); }
}

.subnet-details, .performance-details {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 8px;
    text-align: center;
    line-height: 1.2;
    font-weight: 500;
}

.flip-card:hover .flip-card-inner { transform: none; }
.flip-card-inner.flipped:hover     { transform: rotateY(180deg); }

/* Responsive için küçük ekranlarda font boyutunu ayarla */
@media (max-width: 768px) {
    .breakdown-item {
        font-size: 0.7rem;
        padding: 3px 6px;
    }
    
    .subnet-details, .performance-details {
        font-size: 0.65rem;
    }
}

    </style>
</head>
<body>


    <header class="header">
        <h1><i class="fas fa-wifi"></i> Netinfo</h1>
        <div class="subtitle">Access Point Dashboard</div>
    </header>

    <div class="container">
       <!-- Stats Row -->
<div id="statsRow" class="stats-row">
    <div class="stat-card flip-card">
        <div class="flip-card-inner" onclick="flipCard(this)">
            <div class="flip-card-front">
                <div class="stat-icon"><i class="fas fa-network-wired"></i></div>
                <div class="stat-value" id="apStatusValue">0/0</div>
                <div class="stat-label">Aktif/Toplam AP</div>
            </div>
            <div class="flip-card-back">
                <div class="breakdown-stats" id="apBreakdown">
                    <div class="breakdown-item">Online: <span id="onlineCount">0</span></div>
                    <div class="breakdown-item">Offline: <span id="offlineCount">0</span></div>
                </div>
                <div class="stat-label">AP Durumu</div>
            </div>
        </div>
    </div>
	
	
    
    <div class="stat-card flip-card">
        <div class="flip-card-inner" onclick="flipCard(this)">
            <div class="flip-card-front">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-value" id="totalClientsValue">0</div>
                <div class="stat-label">Toplam Client</div>
            </div>
            <div class="flip-card-back">
                <div class="breakdown-stats" id="ssidBreakdown">
                    <!-- SSID breakdown buraya gelecek -->
                </div>
                <div class="stat-label">SSID Dağılımı</div>
            </div>
        </div>
    </div>

    <div class="stat-card flip-card critical-subnet-card">
        <div class="flip-card-inner" onclick="flipCard(this)">
            <div class="flip-card-front">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-value" id="criticalSubnetValue">--%</div>
                <div class="stat-label" id="criticalSubnetLabel">Kritik VLAN Kapasitesi</div>
                <div class="subnet-details" id="criticalSubnetDetails">Hesaplanıyor...</div>
            </div>
            <div class="flip-card-back">
                <div class="breakdown-stats" id="topSubnetsBreakdown">
                    <!-- Top 5 kritik subnet buraya gelecek -->
                </div>
                <div class="stat-label">En Kritik 5 Subnet</div>
            </div>
        </div>
    </div>

    <div class="stat-card flip-card performance-card">
        <div class="flip-card-inner" onclick="flipCard(this)">
            <div class="flip-card-front">
    <div class="stat-icon"><i class="fas fa-fire"></i></div>
    <div class="stat-value" id="performanceValue">---</div>
    <div class="stat-label">En Yoğun AP</div>
    <div class="performance-details" id="performanceDetails">Yükleniyor...</div>
</div>
            <div class="flip-card-back">
                <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                <div class="breakdown-stats" id="topAPsBreakdown">
                    <!-- Top 5 yoğun AP buraya gelecek -->
                </div>
                <div class="stat-label">En Yoğun 5 AP</div>
            </div>
        </div>
    </div>
</div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Charts Section -->
            <div class="charts-section">
    <!-- Client Load Timeline Chart -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            Client Yoğunluk Trendi (Saatlik Peak)
        </div>
        <div class="chart-wrapper">
            <canvas id="loadChart"></canvas>
        </div>
    </div>

    <!-- SSID Kullanım Dağılımı -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-wifi"></i>
            SSID Kullanım Dağılımı
        </div>
        <div id="ssidCards" class="ssid-cards-grid">
            <!-- SSID kartları buraya yüklenecek -->
        </div>
    </div>

<!-- Frequency & Channel Charts -->
<div class="chart-container">
    <div class="chart-title">
        <i class="fas fa-broadcast-tower"></i>
        Genel Frekans Dağılımı
    </div>
    <div class="chart-wrapper">
        <canvas id="freqPieChart"></canvas>
    </div>
</div>

<div class="chart-container">
    <div class="chart-title">
        <i class="fas fa-wave-square"></i>
        Depo Bazlı Kanal Yoğunluğu
    </div>
    <div class="chart-wrapper">
        <canvas id="channelBarChart"></canvas>
    </div>
</div>






</div>


            <!-- AP List Section -->
            <div class="ap-list-section">
                <div class="controls-wrapper">
    <div class="search-row">
        <input type="text" id="searchInput" class="search-input" placeholder="AP adı, IP, client MAC/hostname/IP ile ara...">
        
        <div class="filter-icons">
            <button class="filter-icon-btn" id="statusFilterBtn" title="Durum Filtresi">
                <i class="fas fa-power-off"></i>
            </button>
            <button class="filter-icon-btn" id="sortFilterBtn" title="Sıralama Seçenekleri">
                <i class="fas fa-sort"></i>
            </button>
            <button class="filter-icon-btn" id="clientFilterBtn" title="Client Filtresi">
                <i class="fas fa-users"></i>
            </button>
        </div>
        
        <button class="refresh-btn" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i>
            Yenile
        </button>
    </div>
    
    <!-- Collapsible filter panel -->
    <div class="filters-panel" id="filtersPanel" style="display: none;">
        <div class="filter-group">
            <label class="filter-label">Durum:</label>
            <select id="statusFilter" class="filter-select">
                <option value="all">Tüm Durumlar</option>
                <option value="online">Sadece Online</option>
                <option value="offline">Sadece Offline</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Sıralama:</label>
            <select id="sortFilter" class="filter-select">
                <option value="name">Ada Göre Sırala</option>
                <option value="clients-desc">En Çok Client</option>
                <option value="clients-asc">En Az Client</option>
                <option value="status">Durum (Online Üstte)</option>
                <option value="location">Lokasyona Göre</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Client Filtresi:</label>
            <select id="clientFilter" class="filter-select">
                <option value="all">Tüm AP'ler</option>
                <option value="hasClients">Client'ı Olanlar</option>
                <option value="noClients">Client'ı Olmayanlar</option>
                <option value="highLoad">Yoğun Olanlar (5+)</option>
            </select>
        </div>
    </div>
    
    <!-- Özet satırı kaldırıldı -->
</div>

                <div id="apGrid" class="ap-grid">
                    <!-- AP cards will be loaded here -->
                </div>
            </div>
        </div>

        <div id="lastUpdate" class="last-update">
            Son güncelleme: Yükleniyor...
        </div>
    </div>

    <!-- Client Details Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">AP Client Detayları</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
                <div class="table-wrapper">
                    <table id="clientsTable" class="clients-table">
                        <thead>
                            <tr>
                                <th style="width: 20%">Hostname</th>
                                <th style="width: 15%">IP Address</th>
                                <th style="width: 18%">MAC Address</th>
                                <th style="width: 10%">WLAN</th>
                                <th style="width: 17%">Sinyal Gücü</th>
                                <th style="width: 12%">Bağlantı Süresi</th>
                                <th style="width: 8%">Radio</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let apData = [];
        let filteredAPData = [];
        let isLoading = false;
        let statusFilter = 'all'; // all, online, offline
		let refreshTimer = null;
		let inFlightController = null;

		let clientLoadHistory = [];

        // XSS protection helper
        function escapeHtml(str) {
            if (str == null) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // API Endpoints
        const API_BASE = '/Netinfo/api/device';
        const MAIN_ENDPOINT = `${API_BASE}/ap-dashboard`;

        // Charts
        let loadChart = null;
        let signalChart = null;

        // Initialize dashboard immediately
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        // localStorage yerine sessionStorage kullan (sayfa kapanınca silinir)
function saveCacheData() {
    try {
        const cacheData = {
            apData: apData,
            timestamp: Date.now(),
            clientLoadHistory: clientLoadHistory
        };
        sessionStorage.setItem('ap-dashboard-cache', JSON.stringify(cacheData));
    } catch (e) {
        console.warn('Cache save failed:', e);
    }
}

function loadCacheData() {
    try {
        const cached = sessionStorage.getItem('ap-dashboard-cache');
        if (cached) {
            const data = JSON.parse(cached);
            const age = Date.now() - data.timestamp;
            
            // 10 dakikadan eski cache'i kullanma
            if (age < 10 * 60 * 1000) {
                apData = data.apData || [];
                filteredAPData = [...apData];
                clientLoadHistory = data.clientLoadHistory || [];
                return true;
            }
        }
    } catch (e) {
        console.warn('Cache load failed:', e);
    }
    return false;
}

function loadClientHistory() {
    // Bu fonksiyonu boşalt  
    return false;
}

function saveClientHistory() {
    // Bu fonksiyonu boşalt
}

async function initializeDashboard() {
    try {
        renderPlaceholderStats();
        renderPlaceholderGrid();
        setupSearchAndFilters();
        
        await loadAPData(); // Bu çağrı içinde loadHistoricalData() da çağrılsın
        
        renderStats();
        renderCharts(); 
        renderAPGrid();
        updateLastUpdateTime();
        setupFilterToggles();
        
        // Auto-refresh
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(() => {
            if (!isLoading) refreshData();
        }, 300000);
        
    } catch (error) {
        console.error('Dashboard initialization error:', error);
        showError('Dashboard yüklenirken hata oluştu');
    }
}

// Yeni fonksiyon ekle
function setupFilterToggles() {
    document.getElementById('statusFilterBtn').addEventListener('click', () => toggleFilterPanel());
    document.getElementById('sortFilterBtn').addEventListener('click', () => toggleFilterPanel());
    document.getElementById('clientFilterBtn').addEventListener('click', () => toggleFilterPanel());
}

function toggleFilterPanel() {
    const panel = document.getElementById('filtersPanel');
    const isVisible = panel.style.display !== 'none';
    
    panel.style.display = isVisible ? 'none' : 'block';
    
    // Button active state
    document.querySelectorAll('.filter-icon-btn').forEach(btn => {
        btn.classList.toggle('active', !isVisible);
    });
}

// refreshData fonksiyonuna da cache save ekle:
async function refreshData() {
    if (isLoading) return;
    isLoading = true;
    try {
        await loadAPData();
        saveCacheData(); // Bunu ekle
        renderStats();
        renderCharts();
        filterAndSortAPs();
        updateLastUpdateTime();
        console.log('Dashboard refreshed successfully');
    } catch (error) {
        console.error('Refresh error:', error);
        showError('Veri yenilenirken hata oluştu', error?.message);
    } finally {
        isLoading = false;
    }
}

function renderPlaceholderStats() {
    // ID'lerin varlığını kontrol et
    const elements = [
        'apStatusValue',
        'totalClientsValue', 
        'criticalSubnetValue',
        'performanceValue'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = '---';
        } else {
            console.warn(`Element not found: ${id}`);
        }
    });
}

function renderPlaceholderGrid() {
    const container = document.getElementById('apGrid');
    container.innerHTML = `
        <div style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px; grid-column: 1 / -1;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <div>AP verileri yükleniyor...</div>
        </div>
    `;
}

async function loadAPData() {
    if (inFlightController) {
        try { inFlightController.abort(); } catch {}
    }
    inFlightController = new AbortController();
    const { signal } = inFlightController;

    const TIMEOUT_MS = 15000;
    const t = setTimeout(() => {
        try { inFlightController.abort(); } catch {}
    }, TIMEOUT_MS);

    const prevAPData = apData.slice();

    try {
        console.log('Fetching AP data from:', MAIN_ENDPOINT);
        const response = await fetch(MAIN_ENDPOINT, {
            signal,
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
        });

        console.log('Fetch status:', response.status, response.statusText);
        const raw = await response.text();
        console.log('Raw length:', raw.length);
        
        if (!response.ok) {
            throw new Error(`API ${response.status} ${response.statusText} — body first 200: ${raw.slice(0,200)}`);
        }

        let data;
        try {
            data = JSON.parse(raw);
        } catch (e) {
            throw new Error('JSON parse failed — first 200: ' + raw.slice(0,200));
        }

        console.log('API Response (keys):', Object.keys(data || {}));

        if (data && data.success && data.inventory) {
            const inv = data.inventory;
            // ✅ hem eski hem yeni format desteklenir
            apData = Array.isArray(inv.data) ? inv.data : Array.isArray(inv) ? inv : [];
            filteredAPData = apData.slice();

            console.log("Loaded AP count:", apData.length);

            if (data.hourly_stats) {
                clientLoadHistory = Object.entries(data.hourly_stats).map(([hourKey, hourData]) => {
                    const [dateStr, hourStr] = hourKey.split('_');
                    const hour = parseInt(hourStr);
                    return {
                        timeKey: hourKey,
                        hour,
                        label: String(hour).padStart(2, '0') + ':00',
                        count: typeof hourData === 'number' ? hourData : hourData.total_clients,
                        timestamp: new Date(`${dateStr}T${String(hour).padStart(2, '0')}:00:00`).getTime(),
                        details: typeof hourData === 'number' ? null : hourData
                    };
                });
                console.log('Historical data loaded:', clientLoadHistory.length);
            } else {
                console.warn('No hourly_stats in API response');
                clientLoadHistory = [];
            }
        } else {
            console.warn('Unexpected API shape:', data);
            throw new Error('Invalid API response structure');
        }

    } catch (err) {
        console.error('AP data load error:', err);
        apData = prevAPData;
        filteredAPData = prevAPData.slice();
    } finally {
        clearTimeout(t);
        inFlightController = null;
    }
}


function updateClientHistory() {
    // Bu fonksiyonu boşalt - artık backend'de tutuyoruz
    console.log('Client-side history disabled - using backend data');
}

async function loadHistoricalData() {
    try {
        // Şimdilik mevcut AP dashboard'dan hourly_stats al
        const response = await fetch(MAIN_ENDPOINT);
        if (response.ok) {
            const data = await response.json();
            
            // Eğer API'ye hourly_stats eklendiyse
            if (data.hourly_stats) {
                clientLoadHistory = Object.entries(data.hourly_stats).map(([hourKey, count]) => {
                    const [dateStr, hourStr] = hourKey.split('_');
                    const hour = parseInt(hourStr);
                    
                    return {
                        timeKey: hourKey,
                        hour: hour,
                        label: String(hour).padStart(2, '0') + ':00',
                        count: count,
                        timestamp: new Date(`${dateStr}T${String(hour).padStart(2, '0')}:00:00`).getTime()
                    };
                });
                
                console.log('Backend historical data loaded:', clientLoadHistory.length, 'entries');
                return true;
            }
        }
    } catch (error) {
        console.error('Historical data load failed:', error);
    }
    return false;
}

// JSON şemasını uygulayan yardımcı (mevcut koddan ayrıştırıldı)
function applyApDashboardData(data) {
    if (data && data.success && data.inventory && data.inventory.success) {
        apData = Array.isArray(data.inventory.data) ? data.inventory.data : [];
        filteredAPData = apData.slice();

        // clientLoadHistory güncellemesi (mevcut mantığın aynısı)
        const currentTime = new Date();
        const currentHour = currentTime.getHours();
        const timeLabel = String(currentHour).padStart(2, '0') + ':00';
        const totalClients = apData.reduce((sum, ap) => sum + (ap.wireless_clients_numbers || 0), 0);

        const existingIndex = clientLoadHistory.findIndex(item => item.hour === currentHour);
        if (existingIndex >= 0) {
            clientLoadHistory[existingIndex] = { hour: currentHour, label: timeLabel, count: totalClients };
        } else {
            clientLoadHistory.push({ hour: currentHour, label: timeLabel, count: totalClients });
        }
        if (clientLoadHistory.length > 24) {
            clientLoadHistory = clientLoadHistory.slice(-24);
        }
    } else {
        throw new Error('Invalid API response structure');
    }
}


        function flipCard(cardInner) {
    cardInner.classList.toggle('flipped');
}



function renderSSIDBreakdown() {
    const ssidCounts = { 'NULL': 0, 'PURPLE': 0, 'ORANGE': 0, 'BLANK': 0, 'AXS': 0 };
    
    apData.forEach(ap => {
        if (ap.wireless_clients) {
            ap.wireless_clients.forEach(client => {
                const ssid = client.wlan || 'NULL';
                if (ssidCounts.hasOwnProperty(ssid)) {
                    ssidCounts[ssid]++;
                }
            });
        }
    });
    
    const breakdown = document.getElementById('ssidBreakdown');
    breakdown.innerHTML = Object.entries(ssidCounts)
        .filter(([, count]) => count > 0)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 4)
        .map(([ssid, count]) => `
            <div class="breakdown-item">
                ${escapeHtml(ssid)}: <span>${escapeHtml(count)}</span>
            </div>
        `).join('');
}

function renderCriticalSubnet() {
    // --- Yardımcı: SSID -> VLAN havuzu
    function ssidToVlanKey(ssid) {
        const s = String(ssid || 'NULL').toUpperCase();
        if (s === 'PURPLE' || s === 'NULL')  return 'vlan40';
        if (s === 'ORANGE' || s === 'BLANK') return 'vlan1140';
        return null; // AXS vb. kapasite hesabına dahil değilse
    }

    // --- 1) Lokasyon setini oluştur
    const locations = new Set();
    apData.forEach(ap => {
        const loc = extractLocationCode(ap.hostname);
        if (loc && loc !== 'Unknown' && VLAN_SUBNETS[loc]) locations.add(loc);
    });

    // --- 2) Tek geçişte lokasyon+VLAN havuzu bazında agregasyon
    // agg[loc][vlanKey] = { used, total, subnet, ssidCounts: { PURPLE: n, NULL: n, ORANGE: n, BLANK: n } }
    const agg = {};
    locations.forEach(loc => {
        agg[loc] = {};
        ['vlan40', 'vlan1140'].forEach(vlanKey => {
            const subnet = VLAN_SUBNETS[loc][vlanKey];
            if (!subnet) return;
            agg[loc][vlanKey] = {
                used: 0,
                total: calculateSubnetCapacity(subnet),
                subnet,
                ssidCounts: { PURPLE: 0, NULL: 0, ORANGE: 0, BLANK: 0 }
            };
        });
    });

    apData.forEach(ap => {
        const loc = extractLocationCode(ap.hostname);
        if (!loc || !agg[loc]) return;
        (ap.wireless_clients || []).forEach(c => {
    const s = String(c.wlan || 'NULL').toUpperCase();
    const vlanKey = ssidToVlanKey(s);
    if (!vlanKey || !agg[loc][vlanKey]) return;
    agg[loc][vlanKey].used += 1;
    if (agg[loc][vlanKey].ssidCounts[s] != null) {
        agg[loc][vlanKey].ssidCounts[s] += 1;
    }
});

    });

    // --- 3) Satır dizisi: lokasyon+VLAN havuzu + etiket için baskın SSID
    const rows = [];
    Object.entries(agg).forEach(([loc, byVlan]) => {
        Object.entries(byVlan).forEach(([vlanKey, info]) => {
            const { used, total, subnet, ssidCounts } = info;
            if (!total) return;

            // Havuzdaki baskın SSID (etiket için)
            const candidates = vlanKey === 'vlan40' ? ['NULL', 'PURPLE'] : ['ORANGE', 'BLANK'];
            let labelSSID = candidates[0];
            if ((ssidCounts[candidates[1]] || 0) > (ssidCounts[candidates[0]] || 0)) {
                labelSSID = candidates[1];
            }

            const percentage = total > 0 ? Math.round((used / total) * 1000) / 10 : 0;
            rows.push({ locationCode: loc, vlanKey, labelSSID, subnet, used, total, percentage });
        });
    });

    // Pozitif kullanımlar öncelik; hiç yoksa tümü
    const positive = rows.filter(r => r.used > 0);
    const source = positive.length ? positive : rows;

    if (!source.length) {
        const card = document.querySelector('.critical-subnet-card');
        if (card) card.className = 'stat-card flip-card critical-subnet-card safe';
        document.getElementById('criticalSubnetValue').textContent = '--%';
        document.getElementById('criticalSubnetLabel').textContent = 'En Kritik Subnet';
        document.getElementById('criticalSubnetDetails').textContent = 'Aktif kullanım yok';
        document.getElementById('topSubnetsBreakdown').innerHTML = '';
        return;
    }

    // --- 4) En kritik ve Top 5
    source.sort((a, b) => b.percentage - a.percentage);
    const critical = source[0];

    // Kart sınıfı / ikon (ikon yoksa sessiz geçer)
    const card = document.querySelector('.critical-subnet-card');
    if (card) {
        const icon = card.querySelector('.stat-icon i');
        if (critical.percentage > 80) {
            card.className = 'stat-card flip-card critical-subnet-card';
            if (icon) icon.className = 'fas fa-exclamation-triangle';
        } else if (critical.percentage > 60) {
            card.className = 'stat-card flip-card critical-subnet-card warning';
            if (icon) icon.className = 'fas fa-exclamation-circle';
        } else {
            card.className = 'stat-card flip-card critical-subnet-card safe';
            if (icon) icon.className = 'fas fa-check-circle';
        }
    }

    // Ön yüz değerleri
    if (typeof animateCounter === 'function') {
        animateCounter('criticalSubnetValue', critical.percentage, '%');
    } else {
        document.getElementById('criticalSubnetValue').textContent =
            `${critical.percentage.toFixed(1)}%`;
    }
    document.getElementById('criticalSubnetLabel').textContent =
        `${critical.locationCode} ${critical.labelSSID}`;
    document.getElementById('criticalSubnetDetails').textContent =
        `${critical.used}/${critical.total} • ${critical.subnet}`;

    // Top 5 (pozitif varsa ondan, yoksa tümünden)
    const top5 = (positive.length ? positive : rows)
        .sort((a, b) => b.percentage - a.percentage)
        .slice(0, 5);

    document.getElementById('topSubnetsBreakdown').innerHTML = top5.map(r => `
        <div class="breakdown-item">
            ${escapeHtml(r.locationCode)} ${escapeHtml(r.labelSSID)}: <span>${escapeHtml(r.percentage.toFixed(1))}%</span>
        </div>
    `).join('');
}




function renderStats() {
    if (!apData || apData.length === 0) return;
    
    const totalAPs = apData.length;
    const activeAPs = apData.filter(ap => ap.is_up || ap.ping_state === 'up').length;
    const offlineAPs = totalAPs - activeAPs;
    const totalClients = apData.reduce((sum, ap) => sum + (ap.wireless_clients_numbers || 0), 0);
    
    // AP Status Card
    animateValue('apStatusValue', `${activeAPs}/${totalAPs}`);
    document.getElementById('onlineCount').textContent = activeAPs;
    document.getElementById('offlineCount').textContent = offlineAPs;
    
    // Client ve SSID breakdown
    animateCounter('totalClientsValue', totalClients);
    renderSSIDBreakdown();
    
    // En kritik subnet
    renderCriticalSubnet();
    
    // Performance stats - En yoğun AP'yi göster (ÖN YÜZ) - TAM HOSTNAME
    const sortedByClients = apData
        .filter(ap => (ap.wireless_clients_numbers || 0) > 0)
        .sort((a, b) => (b.wireless_clients_numbers || 0) - (a.wireless_clients_numbers || 0));

    if (sortedByClients.length > 0) {
        const topAP = sortedByClients[0];
        
        document.getElementById('performanceValue').textContent = topAP.hostname;
        
        // Zengin detay bilgisi için en son saatlik veriyi kontrol et
        let detailText = `${topAP.wireless_clients_numbers} client • ${extractLocationCode(topAP.hostname)}`;
        
        if (clientLoadHistory.length > 0) {
            const latestHour = clientLoadHistory[clientLoadHistory.length - 1];
            // Zengin veri varsa kullan, yoksa basit format
            if (latestHour.details && latestHour.details.uptime_percentage !== undefined) {
                detailText = `${topAP.wireless_clients_numbers} client • ${latestHour.details.uptime_percentage}% uptime • Ort: ${latestHour.details.avg_clients_per_ap}/AP`;
            }
        }
        
        document.getElementById('performanceDetails').textContent = detailText;
    } else {
        document.getElementById('performanceValue').textContent = 'N/A';
        document.getElementById('performanceDetails').textContent = 'Aktif client yok';
    }
    
    // Top 5 yoğun AP'leri göster - TAM HOSTNAME (ARKA YÜZ)
    const topAPs = document.getElementById('topAPsBreakdown');
    topAPs.innerHTML = sortedByClients
        .slice(0, 5)
        .map(ap => `
            <div class="breakdown-item">
                <span style="font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(ap.hostname)}</span>
                <span>${escapeHtml(ap.wireless_clients_numbers || 0)}</span>
            </div>
        `).join('');
}

function animateValue(elementId, targetValue) {
    document.getElementById(elementId).textContent = targetValue;
}

        function renderCharts() {
    if (!apData || apData.length === 0) return;

    renderLoadChart();
    renderSignalChart();
    renderFrequencyAndChannelCharts(); // 👈 ekledik
}

        function renderLoadChart() {
    const canvas = document.getElementById('loadChart');
    const ctx = canvas.getContext('2d');

    if (loadChart) loadChart.destroy();

    // Son 24 saatlik veri
    const loadData = [];
    const labels = [];
    const now = new Date();

    for (let i = 23; i >= 0; i--) {
        const time = new Date(now.getTime() - (i * 60 * 60 * 1000));
        const hourLabel = String(time.getHours()).padStart(2, '0') + ':00';
        const hourNum = time.getHours();

        const historyItem = clientLoadHistory.find(item => item.hour === hourNum);
        const count = historyItem ? historyItem.count : 0;

        labels.push(hourLabel);
        loadData.push({
            y: count,
            historyItem: historyItem
        });
    }

    // Renkler ve gradyan (hafif şeffaf)
    const goldSolid = 'rgba(255, 215, 0, 1)';
    const goldBorder = 'rgba(255, 215, 0, 0.95)';
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, 'rgba(255, 215, 0, 0.25)');
    gradient.addColorStop(1, 'rgba(255, 215, 0, 0.00)');

    // Çizgiye hafif parlama vermek için küçük bir plugin
    const glowLine = {
        id: 'glowLine',
        beforeDatasetsDraw(chart) {
            const { ctx } = chart;
            ctx.save();
            ctx.shadowColor = 'rgba(255, 215, 0, 0.6)';
            ctx.shadowBlur = 12;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            // Çizgiler daha parlak görünsün
            ctx.globalCompositeOperation = 'lighter';
        },
        afterDatasetsDraw(chart) {
            chart.ctx.restore();
        }
    };

    loadChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Saatlik En Yüksek Client Sayısı',
                data: loadData.map(d => d.y),
                borderColor: goldBorder,
                backgroundColor: gradient,
                borderWidth: 2.5,
                fill: true,
                tension: 0.35,
                pointBackgroundColor: 'rgba(255, 215, 0, 0.85)',
                pointBorderColor: goldSolid,
                pointRadius: 3,
                pointHoverRadius: 7,
                pointHitRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 8, right: 12, bottom: 6, left: 6 } },
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'rgba(255, 255, 255, 0.85)',
                        boxWidth: 12,
                        boxHeight: 12,
                        usePointStyle: true,
                        pointStyle: 'line'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(20, 20, 20, 0.85)',
                    titleColor: '#FFD700',
                    bodyColor: 'rgba(255,255,255,0.95)',
                    borderColor: '#FFD700',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: false,
                    callbacks: {
                        title: function (context) {
                            return `Saat ${context[0].label}`;
                        },
                        label: function (context) {
                            const index = context.dataIndex;
                            const historyItem = loadData[index].historyItem;

                            if (!historyItem) {
                                return `Peak Client: ${context.parsed.y}`;
                            }

                            const lines = [`Peak Client: ${historyItem.count}`];

                            if (historyItem.details) {
                                const details = historyItem.details;

                                // En yoğun AP (tam hostname)
                                if (details.top_aps && details.top_aps.length > 0) {
                                    const topAP = details.top_aps[0];
                                    lines.push(`En Yoğun AP: ${topAP.hostname} (${topAP.clients})`);
                                }

                                // SSID breakdown
                                if (details.ssid_breakdown) {
                                    const topSSID = Object.keys(details.ssid_breakdown)[0];
                                    const topSSIDCount = details.ssid_breakdown[topSSID];
                                    lines.push(`En Yoğun SSID: ${topSSID} (${topSSIDCount})`);
                                }
                            }

                            return lines;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.08)',
                        drawBorder: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.8)',
                        padding: 6
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.06)',
                        drawBorder: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.8)',
                        maxRotation: 0,
                        autoSkip: true,
                        padding: 6
                    }
                }
            }
        },
        plugins: [glowLine]
    });
}

		
		function updateSignalSummary() {
    const signalSummary = document.getElementById('signalSummary');
    
    const signalRanges = {
        'Mükemmel': { count: 0, range: '(-30 to -40 dBm)', color: '#10B981' },
        'İyi': { count: 0, range: '(-41 to -55 dBm)', color: '#22C55E' },
        'Orta': { count: 0, range: '(-56 to -70 dBm)', color: '#F59E0B' },
        'Zayıf': { count: 0, range: '(-71+ dBm)', color: '#EF4444' }
    };

    let totalSignalClients = 0;

    apData.forEach(ap => {
        if (ap.enhanced_wireless && ap.enhanced_wireless.client_radio_mapping) {
            ap.enhanced_wireless.client_radio_mapping.forEach(client => {
                const power = client.radio_power_dbm || -50;
                totalSignalClients++;
                
                if (power >= -40) {
                    signalRanges['Mükemmel'].count++;
                } else if (power >= -55) {
                    signalRanges['İyi'].count++;
                } else if (power >= -70) {
                    signalRanges['Orta'].count++;
                } else {
                    signalRanges['Zayıf'].count++;
                }
            });
        }
    });

    signalSummary.innerHTML = Object.entries(signalRanges).map(([level, data]) => `
        <div class="signal-summary-card" style="border-left: 4px solid ${escapeHtml(data.color)};">
            <h4>${escapeHtml(level)}</h4>
            <div class="signal-count" style="color: ${escapeHtml(data.color)};">${escapeHtml(data.count)}</div>
            <div class="signal-range">${escapeHtml(data.range)}</div>
        </div>
    `).join('');
}

function renderSignalChart() {
    // SSID kullanım verilerini topla
    const ssidUsage = {
        'PURPLE': 0,
        'ORANGE': 0,
        'NULL': 0,
        'BLANK': 0,
        'AXS': 0
    };

    let totalClients = 0;

    apData.forEach(ap => {
        if (ap.wireless_clients && ap.wireless_clients.length > 0) {
            ap.wireless_clients.forEach(client => {
                const ssid = client.wlan || 'NULL';
                if (ssidUsage.hasOwnProperty(ssid)) {
                    ssidUsage[ssid]++;
                    totalClients++;
                }
            });
        }
    });

    // Sabit renkler ve ikonlar
    const ssidConfig = {
'PURPLE': { color: 'rgba(138, 43, 226, 0.8)', icon: 'fas fa-gem' },
'ORANGE': { color: 'rgba(255, 165, 0, 0.8)', icon: 'fas fa-sun' },
'NULL': { color: 'rgba(236, 72, 153, 0.8)', icon: 'fas fa-star' },
'BLANK': { color: 'rgba(129, 140, 248, 0.8)', icon: 'fas fa-minus-circle' },
'AXS': { color: 'rgba(59, 130, 246, 0.8)', icon: 'fas fa-shield-alt' }
    };

    const cardsContainer = document.getElementById('ssidCards');
    
    cardsContainer.innerHTML = Object.entries(ssidUsage).map(([ssid, count]) => {
        const percentage = totalClients > 0 ? ((count / totalClients) * 100).toFixed(1) : 0;
        const config = ssidConfig[ssid];

        return `
            <div class="ssid-card" style="border-color: ${escapeHtml(config.color)};">
                <div class="ssid-name">${escapeHtml(ssid)}</div>
                <div class="ssid-client-count" style="color: ${escapeHtml(config.color)};">${escapeHtml(count)}</div>
                <div class="ssid-percentage">%${escapeHtml(percentage)}</div>
                <div class="ssid-icon" style="background: ${escapeHtml(config.color)};">
                    <i class="${escapeHtml(config.icon)}"></i>
                </div>
            </div>
        `;
    }).join('');
}

function renderAPGrid() {
    const container = document.getElementById('apGrid');

    if (!filteredAPData || filteredAPData.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px; grid-column: 1 / -1;">Kriterlere uygun AP bulunamadı</div>';
        // renderAPSummary() çağrısını kaldır - element artık yok
        return;
    }

    container.innerHTML = filteredAPData.map(ap => {
        // Dominant SSID'yi bul
        const clients = ap.wireless_clients || [];
        const ssidCounts = {};
        clients.forEach(client => {
            const ssid = client.wlan || 'NULL';
            ssidCounts[ssid] = (ssidCounts[ssid] || 0) + 1;
        });
        const dominantSSID = Object.keys(ssidCounts).length
            ? Object.keys(ssidCounts).reduce((a, b) => (ssidCounts[a] > ssidCounts[b] ? a : b))
            : 'NULL';

        // Lokasyon kodunu çıkar
        const locationCode = extractLocationCode(ap.hostname);

        // VLAN kapasitesini hesapla
        const vlanCapacity = calculateLocationVlanUsage(locationCode, dominantSSID);

        // Kapasite göstergesi
        let capacityIndicator = '';
        if (vlanCapacity.total > 0) {
            const perc = vlanCapacity.percentage;
            const colorClass = perc > 80 ? 'danger' : (perc > 60 ? 'warning' : 'safe');
            
            const thisAPContribution = ap.wireless_clients ? 
                ap.wireless_clients.filter(c => {
                    const ssid = c.wlan || 'NULL';
                    return ((dominantSSID === 'NULL' || dominantSSID === 'PURPLE') && 
                            (ssid === 'NULL' || ssid === 'PURPLE')) ||
                           ((dominantSSID === 'BLANK' || dominantSSID === 'ORANGE') && 
                            (ssid === 'BLANK' || ssid === 'ORANGE'));
                }).length : 0;
            
            const statusIcon = colorClass === 'danger' ? 'fa-exclamation-triangle' : 
                              (colorClass === 'warning' ? 'fa-exclamation-circle' : 'fa-check-circle');
            
            capacityIndicator = `
                <div class="vlan-capacity ${escapeHtml(colorClass)}">
                    <div class="capacity-text">
                        <div class="capacity-main">
                            <i class="fas ${escapeHtml(statusIcon)}"></i>
                            ${escapeHtml(vlanCapacity.used)}/${escapeHtml(vlanCapacity.total)} IP (${escapeHtml(perc)}%)
                        </div>
                        ${thisAPContribution > 0 ? `<div class="capacity-this-ap">Bu AP: ${escapeHtml(thisAPContribution)}</div>` : ''}
                    </div>
                    <div class="capacity-bar">
                        <div class="capacity-fill" style="width: ${escapeHtml(perc)}%"></div>
                    </div>
                    <div class="subnet-info">
                        <div class="subnet-address">${escapeHtml(vlanCapacity.subnet)}</div>
                        <div class="vlan-info">${escapeHtml(locationCode)} • ${escapeHtml(dominantSSID)}</div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="ap-card" onclick="showAPDetails('${escapeHtml(ap.hostname)}')">
                <div class="ap-card-header">
                    <div class="ap-name">
                        ${escapeHtml(ap.hostname)}
                        ${ap.wireless_clients_numbers > 0 ? `<span class="client-count-badge">${escapeHtml(ap.wireless_clients_numbers)}</span>` : ''}
                    </div>
                    <div class="ap-status ${ap.is_up || ap.ping_state === 'up' ? 'status-online' : 'status-offline'}">
                        ${ap.is_up || ap.ping_state === 'up' ? 'Online' : 'Offline'}
                    </div>
                </div>

                ${capacityIndicator}

                <div class="ap-details">
                    <div class="detail-item">
                        <div class="detail-label">IP Address</div>
                        <div class="detail-value">${escapeHtml(ap.ipaddress || 'N/A')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Model</div>
                        <div class="detail-value">${escapeHtml(ap.model || 'N/A')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Location</div>
                        <div class="detail-value">${escapeHtml(ap.city || ap.location || 'N/A')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Uptime</div>
                        <div class="detail-value">${escapeHtml(ap.uptime || 'N/A')}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // renderAPSummary() kaldırıldı - artık özet yok
}


        function setupSearchAndFilters() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');
    const clientFilter = document.getElementById('clientFilter');
    
    [searchInput, statusFilter, sortFilter, clientFilter].forEach(element => {
        element.addEventListener('input', filterAndSortAPs);
        element.addEventListener('change', filterAndSortAPs);
    });
}


// Enhanced search function
function filterAndSortAPs() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const sortBy = document.getElementById('sortFilter').value;
    const clientFilter = document.getElementById('clientFilter').value;
    
    filteredAPData = apData.filter(ap => {
        // Enhanced search - AP + Client data
        let matchesSearch = false;
        
        if (!searchTerm) {
            matchesSearch = true;
        } else {
            // AP level search
            const apMatches = 
                (ap.hostname && ap.hostname.toLowerCase().includes(searchTerm)) ||
                (ap.ipaddress && ap.ipaddress.includes(searchTerm)) ||
                (ap.model && ap.model.toLowerCase().includes(searchTerm)) ||
                (ap.city && ap.city.toLowerCase().includes(searchTerm)) ||
                (ap.location && ap.location.toLowerCase().includes(searchTerm));
            
            // Client level search
            const clientMatches = ap.wireless_clients && ap.wireless_clients.some(client => 
                (client.hostname && client.hostname.toLowerCase().includes(searchTerm)) ||
                (client.ip_address && client.ip_address.includes(searchTerm)) ||
                (client.mac_address && client.mac_address.toLowerCase().includes(searchTerm)) ||
                (client.username && client.username.toLowerCase().includes(searchTerm))
            );
            
            matchesSearch = apMatches || clientMatches;
        }

        const isOnline = ap.is_up || ap.ping_state === 'up';
        const matchesStatus = statusFilter === 'all' || 
            (statusFilter === 'online' && isOnline) ||
            (statusFilter === 'offline' && !isOnline);

        const clientCount = ap.wireless_clients_numbers || 0;
        const matchesClientFilter = clientFilter === 'all' ||
            (clientFilter === 'hasClients' && clientCount > 0) ||
            (clientFilter === 'noClients' && clientCount === 0) ||
            (clientFilter === 'highLoad' && clientCount >= 5);

        return matchesSearch && matchesStatus && matchesClientFilter;
    });

    // Sorting logic remains the same
    filteredAPData.sort((a, b) => {
        switch(sortBy) {
            case 'name':
                return (a.hostname || '').localeCompare(b.hostname || '');
            case 'clients-desc':
                return (b.wireless_clients_numbers || 0) - (a.wireless_clients_numbers || 0);
            case 'clients-asc':
                return (a.wireless_clients_numbers || 0) - (b.wireless_clients_numbers || 0);
            case 'status':
                const aOnline = a.is_up || a.ping_state === 'up';
                const bOnline = b.is_up || b.ping_state === 'up';
                return bOnline - aOnline;
            case 'location':
                return (a.city || a.location || '').localeCompare(b.city || b.location || '');
            default:
                return 0;
        }
    });

    renderAPGrid();
    // renderAPSummary() kaldırıldı
}

function renderAPSummary() {
    const summaryContainer = document.getElementById('summaryRow');
    const totalFiltered = filteredAPData.length;
    const onlineCount = filteredAPData.filter(ap => ap.is_up || ap.ping_state === 'up').length;
    const totalClients = filteredAPData.reduce((sum, ap) => sum + (ap.wireless_clients_numbers || 0), 0);
    const averageClients = totalFiltered > 0 ? (totalClients / totalFiltered).toFixed(1) : 0;
    
    summaryContainer.innerHTML = `
        <div class="summary-item">
            <div class="summary-number">${escapeHtml(totalFiltered)}</div>
            <div class="summary-label">Gösterilen AP</div>
        </div>
        <div class="summary-item">
            <div class="summary-number">${escapeHtml(onlineCount)}</div>
            <div class="summary-label">Online</div>
        </div>
        <div class="summary-item">
            <div class="summary-number">${escapeHtml(totalClients)}</div>
            <div class="summary-label">Toplam Client</div>
        </div>
        <div class="summary-item">
            <div class="summary-number">${escapeHtml(averageClients)}</div>
            <div class="summary-label">Ort. Client</div>
        </div>
    `;
}




        function showAPDetails(hostname) {
            const ap = apData.find(a => a.hostname === hostname);
            if (!ap) return;
            
            const modal = document.getElementById('clientModal');
            const modalTitle = document.getElementById('modalTitle');
            const tbody = document.querySelector('#clientsTable tbody');
            
            modalTitle.textContent = `${ap.hostname} - Client Detayları`;
            
            if (!ap.wireless_clients || ap.wireless_clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">Bu AP\'de aktif client bulunmuyor</td></tr>';
            } else {
                tbody.innerHTML = ap.wireless_clients.map(client => {
                    let signalStrength = -50;
                    let connectionTime = 'Unknown';
                    let radioId = 'N/A';
                    
                    if (ap.enhanced_wireless && ap.enhanced_wireless.client_radio_mapping) {
                        const radioMapping = ap.enhanced_wireless.client_radio_mapping.find(
                            mapping => mapping.mac_address === client.mac_address
                        );
                        if (radioMapping) {
                            signalStrength = radioMapping.radio_power_dbm || -50;
                            connectionTime = radioMapping.activity || 'Unknown';
                            radioId = radioMapping.radio_id || 'N/A';
                        }
                    }
                    
                    const signalData = getSignalData(signalStrength);
                    
                    return `
                        <tr>
                            <td style="color: #FFD700; font-weight: 600;">${escapeHtml(client.hostname || 'Unknown')}</td>
                            <td style="color: #22C55E; font-family: monospace;">${escapeHtml(client.ip_address || 'N/A')}</td>
                            <td style="color: #8B5CF6; font-family: monospace;">${escapeHtml(client.mac_address || 'N/A')}</td>
                            <td style="color: #F59E0B;">${escapeHtml(client.wlan || 'N/A')}</td>
                            <td>
                                <div class="signal-strength">
                                    <div class="signal-bar">
                                        <div class="signal-fill ${escapeHtml(signalData.class)}" style="width: ${escapeHtml(signalData.percentage)}%"></div>
                                    </div>
                                    <span>${escapeHtml(signalStrength)} dBm</span>
                                </div>
                            </td>
                            <td>${escapeHtml(connectionTime)}</td>
                            <td style="color: #06B6D4;">${escapeHtml(radioId)}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        function getSignalData(dbm) {
            if (dbm >= -40) return { class: 'signal-excellent', percentage: 100 };
            if (dbm >= -55) return { class: 'signal-good', percentage: 80 };
            if (dbm >= -70) return { class: 'signal-fair', percentage: 60 };
            return { class: 'signal-poor', percentage: 30 };
        }

        function calculateAverageUptime() {
            const apsWithUptime = apData.filter(ap => ap.uptime);
            if (apsWithUptime.length === 0) return 0;
            
            const totalHours = apsWithUptime.reduce((sum, ap) => sum + parseUptimeToHours(ap.uptime), 0);
            const avgHours = totalHours / apsWithUptime.length;
            return Math.min((avgHours / (24 * 30)) * 100, 100);
        }

        function parseUptimeToHours(uptime) {
            if (!uptime) return 0;
            
            const regex = /(\d+)\s*days?,?\s*(\d+)\s*hours?/i;
            const match = uptime.match(regex);
            
            if (match) {
                const days = parseInt(match[1]) || 0;
                const hours = parseInt(match[2]) || 0;
                return days * 24 + hours;
            }
            return 0;
        }

        function animateCounter(elementId, targetValue, suffix = '') {
            const element = document.getElementById(elementId);
            const startValue = 0;
            const duration = 1500;
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
                element.textContent = currentValue + suffix;
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }
            
            requestAnimationFrame(updateCounter);
        }

       async function refreshData() {
    if (isLoading) return;
    isLoading = true;
    try {
        await loadAPData();
        renderStats();
        renderCharts();
        filterAndSortAPs();
        updateLastUpdateTime();
        console.log('Dashboard refreshed successfully');
    } catch (error) {
        console.error('Refresh error:', error);
        showError('Veri yenilenirken hata oluştu', error?.message);
    } finally {
        isLoading = false;
    }
}


        function showLoading(show) {
    // Loading overlay kaldırıldığı için bu fonksiyon boş kalacak
    isLoading = show;
}

        function showError(message) {
            alert(`Hata: ${message}`);
        }

        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            const now = new Date();
            lastUpdate.innerHTML = `
                <i class="fas fa-clock"></i>
                Son güncelleme: ${escapeHtml(now.toLocaleString('tr-TR'))}
                <span style="margin-left: 20px;"><i class="fas fa-sync-alt"></i> Otomatik yenileme: Her 5 dakikada</span>
            `;
        }

        // Modal close on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('clientModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
            
            if (e.key === 'Escape') {
                closeModal();
            }
            
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !isLoading) {
                refreshData();
            }
        });

        // Debug function
        window.debugInfo = function() {
            console.log('Dashboard Debug Info:');
            console.log('Total APs:', apData.length);
            console.log('Filtered APs:', filteredAPData.length);
            console.log('Current filter:', statusFilter);
            console.log('Sample AP:', apData[0]);
        };

        console.log('🚀 Netinfo AP Dashboard loaded successfully!');
        console.log('⌨️ Shortcuts: Ctrl+R (refresh), Ctrl+F (search), ESC (close modal)');
		
		// Düzeltilmiş FALLBACK_MAPPING - daha spesifik eşleşmeler önce
const FALLBACK_MAPPING = {
    // ÖNCELİKLİ EŞLEŞMELER (uzun -> kısa)
    'ISTRT2': 'ISTRT',    // TrISTRT2 -> Havalimanı
    'ISTRT': 'ISTRT',     // TrISTRT -> Havalimanı  
    'TIST': 'ISTT8',      // TrTIST -> Güneşli
    'TCHO': 'ISTHQ',      // TrTCHO -> İstanbul HQ
    'CHO': 'ISTHQ',       // CHO -> İstanbul HQ
    
    // DİĞER LOKASYONLAR
    'TADA': 'ADAT8', 'ADA': 'ADAT8',
    'TANK': 'ANKT8', 'ANK': 'ANKT8', 
    'TASR': 'ASRT8', 'ASR': 'ASRT8',
    'TAYT': 'AYTT8', 'AYT': 'AYTT8',
    'TIZM': 'IZMT8', 'IZM': 'IZMT8',
    'TKYA': 'KYAT8', 'KYA': 'KYAT8',
    'TDNZ': 'DNZT8', 'DNZ': 'DNZT8',
    'TGZT': 'GZTT8', 'GZT': 'GZTT8',
    'TBTZ': 'BTZT8', 'BTZ': 'BTZT8',
    'TAOE': 'AOEA', 'AOE': 'AOEA',
    'TAJIA': 'AJIA', 'AJIA': 'AJIA',
    'TOZN': 'BDMA', 'OZN': 'BDMA',
    'TBL5': 'AOEA', 'BL5': 'AOEA',
    'TCC8': 'TEQH', 'CC8': 'TEQH',
    'TSAW': 'SAWT8', 'SAW': 'SAWT8'
};

// Multiple subnet desteği ile VLAN tanımları
const VLAN_SUBNETS = {
    'ADAT8': {
        vlan40: ['10.33.125.0/27'],           // Purple - 30 IP
        vlan1140: ['10.206.157.192/26']       // Orange - 62 IP
    },
    'AJIA': {
        vlan40: ['10.33.124.224/27'],         // Purple - 30 IP
        vlan1140: ['10.206.161.192/28']       // Orange - 14 IP
    },
    'ANKT8': {
        vlan40: ['10.33.254.224/27'],         // Purple - 30 IP
        vlan1140: ['10.206.53.64/26']         // Orange - 62 IP
    },
    'AOEA': {
        vlan40: ['10.34.231.0/26'],           // Purple - 62 IP
        vlan1140: ['10.206.162.64/26']        // Orange - 62 IP
    },
    'ASRT8': {
        vlan40: ['10.33.124.64/27'],          // Purple - 30 IP
        vlan1140: ['10.206.161.224/28']       // Orange - 14 IP
    },
    'AYTT8': {
        vlan40: ['10.33.124.32/27'],          // Purple - 30 IP
        vlan1140: ['10.206.161.32/27']        // Orange - 30 IP
    },
    'BDMA': {
        vlan40: ['10.34.231.128/26'],         // Purple - 62 IP
        vlan1140: ['10.206.157.0/27']         // Orange - 30 IP
    },
    'BTZT8': {
        vlan40: ['10.34.231.64/26'],          // Purple - 62 IP
        vlan1140: ['10.206.157.128/26']       // Orange - 62 IP
    },
    'DNZT8': {
        vlan40: ['10.33.124.0/27'],           // Purple - 30 IP
        vlan1140: ['10.207.60.64/27']         // Orange - 30 IP
    },
    'GZTT8': {
        vlan40: ['10.47.41.192/27'],          // Purple - 30 IP
        vlan1140: ['10.207.60.96/27']         // Orange - 30 IP
    },
    'ISTHQ': {
        vlan40: ['10.34.230.0/25', '10.33.169.192/26'],  // Purple - 126+62 = 188 IP
        vlan1140: ['10.206.63.192/26']                    // Orange - 62 IP
    },
    'ISTRT': {
        vlan40: ['10.34.29.0/24'],            // Purple - 254 IP
        vlan1140: ['10.200.147.192/26']       // Orange - 62 IP
    },
    'ISTT8': {
        vlan40: ['10.34.135.192/26', '172.24.235.128/26'], // Purple - 62+62 = 124 IP
        vlan1140: ['10.206.162.128/25']                      // Orange - 126 IP
    },
    'IZMT8': {
        vlan40: ['10.34.231.192/26'],         // Purple - 62 IP
        vlan1140: ['10.206.62.64/26']         // Orange - 62 IP
    },
    'KYAT8': {
        vlan40: ['10.33.124.96/27'],          // Purple - 30 IP
        vlan1140: ['10.206.161.0/27']         // Orange - 30 IP
    },
    'SAWT8': {
        vlan40: ['10.34.230.128/25'],         // Purple - 126 IP
        vlan1140: ['10.32.3.128/25']          // Orange - 126 IP
    },
    'TEQH': {
        vlan40: ['10.33.124.160/27'],         // Purple - 30 IP
        vlan1140: ['10.32.13.128/26']         // Orange - 62 IP
    }
};

// Geliştirilmiş hostname parsing - SPESİFİK ÖNCE
function extractLocationCode(hostname) {
    if (!hostname) return 'Unknown';
    
    const upper = hostname.toUpperCase();
    
    // Spesifik pattern'leri önce kontrol et
    if (upper.includes('ISTRT2') || upper.includes('ISTRT')) return 'ISTRT';
    if (upper.includes('TIST')) return 'ISTT8';
    if (upper.includes('TCHO') || upper.includes('CHO')) return 'ISTHQ';
    
    // Diğer lokasyonlar için genel mapping
    for (const [key, value] of Object.entries(FALLBACK_MAPPING)) {
        if (upper.includes(key)) {
            return value;
        }
    }
    
    return 'Unknown';
}

function renderFrequencyAndChannelCharts() {
    console.log("🔍 renderFrequencyAndChannelCharts çağrıldı");
    console.log("apData type:", typeof apData, "isArray?", Array.isArray(apData), "length:", apData?.length);

    if (!Array.isArray(apData) || apData.length === 0) {
    console.warn("renderFrequencyAndChannelCharts: apData boş veya geçersiz!", apData);
    return;
}

let freqCounts = { "2.4GHz": 0, "5GHz": 0, "Other": 0 };
let channelCountsPerDepot = {};

apData.forEach(ap => {
    if (!ap?.enhanced_wireless) return;
    const ew = ap.enhanced_wireless;

    if (!channelCountsPerDepot[ap.location]) channelCountsPerDepot[ap.location] = {};

    ew.radio_info?.forEach(radio => {
        if (!radio.frequency_band) return;

        // Frekans sayacı
        freqCounts[radio.frequency_band] = (freqCounts[radio.frequency_band] || 0) + 1;

        // Kanal yoğunluğu sayacı
        if (radio.channel && radio.channel !== "N/A (smt)") {
            const ch = radio.channel.split(" ");
            channelCountsPerDepot[ap.location][ch] = (channelCountsPerDepot[ap.location][ch] || 0) + 1;
        }
    });
});

console.log("🔧 freqCounts:", freqCounts);
console.log("🔧 channelCountsPerDepot:", channelCountsPerDepot);

// --- Pie Chart ---
const pieCanvas = document.getElementById("freqPieChart");
if (!pieCanvas) {
    console.error("freqPieChart canvas bulunamadı!");
    return;
}
const pieCtx = pieCanvas.getContext("2d");
if (window.freqPieChart?.destroy) window.freqPieChart.destroy();

window.freqPieChart = new Chart(pieCtx, {
    type: "pie",
    data: {
        labels: Object.keys(freqCounts),
        datasets: [{
            data: Object.values(freqCounts),
            backgroundColor: [
                "#4D148C", // Koyu mor - Tema rengi
                "#FF6600", // Turuncu - Tema rengi
                "#FFD700"  // Altın sarısı - Tema rengi
            ],
            borderColor: "#fff",
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: "bottom",
                labels: {
                    color: "#FFD700",
                    font: { weight: "600", size: 14 },
                    padding: 20,
                    boxWidth: 18,
                    boxHeight: 18
                }
            },
            title: {
                display: true,
                text: "Genel Frekans Dağılımı",
                color: "#FFD700",
                font: { size: 20, weight: "700" }
            },
            tooltip: {
                bodyFont: { size: 14 },
                titleFont: { size: 16, weight: "600" }
            }
        }
    }
});

// --- Bar Chart ---
const barCanvas = document.getElementById("channelBarChart");
if (!barCanvas) {
    console.error("channelBarChart canvas bulunamadı!");
    return;
}
const barCtx = barCanvas.getContext("2d");
if (window.channelBarChart?.destroy) window.channelBarChart.destroy();

let channels = new Set();
Object.values(channelCountsPerDepot).forEach(chObj => Object.keys(chObj).forEach(ch => channels.add(ch)));
channels = Array.from(channels).sort((a, b) => parseInt(a) - parseInt(b));

const colorPalette = [
    "#4D148C", "#FF6600", "#FFD700", "#9B59B6", "#F39C12", "#F1C40F"
];

const datasets = Object.keys(channelCountsPerDepot).map((depot, i) => ({
    label: depot,
    data: channels.map(ch => channelCountsPerDepot[depot][ch] || 0),
    backgroundColor: colorPalette[i % colorPalette.length],
    borderRadius: 6,
    borderWidth: 1,
    borderColor: "#fff"
}));

window.channelBarChart = new Chart(barCtx, {
    type: "bar",
    data: {
        labels: channels,
        datasets
    },
    options: {
        responsive: true,
        scales: {
            x: {
                stacked: true,
                ticks: { color: "#FFD700", font: { size: 14, weight: "600" } },
                grid: { color: "rgba(255, 215, 0, 0.2)" }
            },
            y: {
                stacked: true,
                beginAtZero: true,
                ticks: { color: "#FFD700", font: { size: 14 } },
                grid: { color: "rgba(255, 215, 0, 0.2)" }
            }
        },
        plugins: {
            legend: {
                position: "bottom",
                labels: {
                    color: "#FFD700",
                    font: { weight: "600", size: 14 },
                    padding: 16,
                    boxWidth: 20,
                    boxHeight: 20
                }
            },
            title: {
                display: true,
                text: "Depo Bazlı Kanal Yoğunluğu",
                color: "#FFD700",
                font: { size: 20, weight: "700" }
            },
            tooltip: {
                bodyFont: { size: 14 },
                titleFont: { size: 16, weight: "600" }
            }
        }
    }
});

}





// Multiple subnet hesaplama
function calculateSubnetCapacity(cidrArray) {
    if (!Array.isArray(cidrArray)) cidrArray = [cidrArray];
    
    return cidrArray.reduce((total, cidr) => {
        const [, prefixLength] = cidr.split('/');
        const hostBits = 32 - parseInt(prefixLength);
        return total + (Math.pow(2, hostBits) - 2);
    }, 0);
}

// Düzeltilmiş VLAN kullanım hesaplama
function calculateLocationVlanUsage(locationCode, ssidType) {
    if (!VLAN_SUBNETS[locationCode]) {
        return { subnet: '', total: 0, used: 0, available: 0, percentage: 0 };
    }
    
    const location = VLAN_SUBNETS[locationCode];
    let vlanSubnets = null;
    
    if ((ssidType === 'NULL' || ssidType === 'PURPLE') && location.vlan40) {
        vlanSubnets = location.vlan40;
    } else if ((ssidType === 'BLANK' || ssidType === 'ORANGE') && location.vlan1140) {
        vlanSubnets = location.vlan1140;
    }
    
    if (!vlanSubnets) {
        return { subnet: '', total: 0, used: 0, available: 0, percentage: 0 };
    }
    
    // Client sayma
    let totalClientsInVlan = 0;
    
    apData.forEach(ap => {
        const apLocationCode = extractLocationCode(ap.hostname);
        
        if (apLocationCode === locationCode && ap.wireless_clients) {
            ap.wireless_clients.forEach(client => {
                const clientSSID = client.wlan || 'NULL';
                
                const sameVlanCategory = 
                    ((ssidType === 'NULL' || ssidType === 'PURPLE') && 
                     (clientSSID === 'NULL' || clientSSID === 'PURPLE')) ||
                    ((ssidType === 'BLANK' || ssidType === 'ORANGE') && 
                     (clientSSID === 'BLANK' || clientSSID === 'ORANGE'));
                
                if (sameVlanCategory) {
                    totalClientsInVlan++;
                }
            });
        }
    });
    
    const totalCapacity = calculateSubnetCapacity(vlanSubnets);
    const available = Math.max(0, totalCapacity - totalClientsInVlan);
    const percentage = totalCapacity > 0 ? Math.round((totalClientsInVlan / totalCapacity) * 1000) / 10 : 0;
    
    return {
        subnet: Array.isArray(vlanSubnets) ? vlanSubnets.join(' + ') : vlanSubnets,
        total: totalCapacity,
        used: totalClientsInVlan,
        available,
        percentage
    };
}

    </script>
</body>
</html>