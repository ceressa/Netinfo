
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netinfo</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    <style>
body {
    font-family: 'Nunito', sans-serif;
    background: linear-gradient(135deg, #4D148C, #FF6600);
    min-height: 100vh;
    margin: 0;
    padding: 0;
    color: #fefefe;
    display: flex;
    flex-direction: column;
    align-items: center;
	justify-content: flex-start;
    padding-top: 50px;
}

.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin-top: 10px;
}

.flip-card {
    margin: 0 auto;
    width: 80%;
    max-width: 400px;
    perspective: 1200px;
}

.flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
}

.flip-card.admin-active .flip-card-inner {
    transform: rotateY(180deg);
}

.flip-card.admin-active .admin-icon {
    display: none;
}

.flip-card.admin-active .report-icon {
    display: flex;
}

.flip-card-front,
.flip-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.5);
}

.flip-card-front {
    background: rgba(255, 255, 255, 0.2);
    transform: rotateY(0deg);
}

.flip-card-back {
    background: rgba(0, 0, 0, 0.8);
    transform: rotateY(180deg);
}

.info-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    padding: 10px;
}

.info-card {
    width: 100%;
    max-width: 250px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 10px;
    text-align: center;
    color: #fff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}


.info-card i {
    font-size: 1.5rem;
    color: #FFD700;
    margin-bottom: 5px;
}

.info-card p {
    margin: 0;
    font-size: 1rem;
}

.info-card:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
}

.copy-icon {
    position: fixed;
    top: 15px;
    right: 140px;
    font-size: 1.5rem;
    background: rgba(123, 0, 0, 0.2);
    border-radius: 50%;
    padding: 12px;
    color: #FFD700;
    cursor: pointer;
    z-index: 1500;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: background 0.3s ease, transform 0.2s ease;
}

.copy-icon:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
}

.admin-icon {
    position: fixed;
    top: 15px;
    right: 80px;
    font-size: 1.5rem;
    background: rgba(123, 0, 0, 0.2);
    border-radius: 50%;
    padding: 12px;
    color: #FFD700;
    cursor: pointer;
    z-index: 1500;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: background 0.3s ease, transform 0.2s ease;
}

.admin-icon:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
}

.switch-icon {
    position: fixed;
    top: 15px;
    right: 20px;
    font-size: 1.5rem;
    background: rgba(123, 0, 0, 0.2);
    border-radius: 50%;
    padding: 12px;
    color: #FFD700;
    cursor: pointer;
    z-index: 1500;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: background 0.3s ease, transform 0.2s ease;
}

.switch-icon:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
}

.report-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 1.5rem;
    background: rgba(255, 0, 0, 0.2);
    border-radius: 50%;
    padding: 12px;
    color: #FFD700;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
}

.report-icon:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #FFA500;
    transform: scale(1.1);
}

.modal-container {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 300px;
    padding: 20px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
    color: #333;
    z-index: 2000;
    text-align: center;
}

.modal-container input {
    width: 90%;
    padding: 12px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f9f9f9;
}

.modal-container .close-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
    font-size: 1.5rem;
    color: #FFD700;
    transition: transform 0.3s ease;
}

.modal-container .close-icon:hover {
    transform: scale(1.2);
}

.modal-container .warning-message {
    background: #FFD700;
    border-radius: 5px;
    padding: 10px;
    color: #333;
    margin-top: 10px;
    font-weight: bold;
}

#switchModal {
    width: 80%;
    height: 80%;
    padding: 20px;
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    z-index: 2000;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
}

#switchModal .close-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
    font-size: 1.5rem;
    color: #FFD700;
}

#switchDetails {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    overflow-y: auto;
    padding: 10px;
}

#switchDetails img {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.modal-container input:focus {
    outline: none;
    border: 2px solid #FF4500;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 0 8px rgba(255, 69, 0, 0.5);
}



.report-panel {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    max-width: 500px;
    height: 100%;
    background: linear-gradient(135deg, #24292e, #0366d6);
    color: #fefefe;
    padding: 20px;
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
    transition: right 0.3s ease-in-out;
    overflow-y: auto;
    z-index: 1100;
}

.report-panel.open {
    right: 0;
}

.report-panel h3 {
    text-align: center;
    font-size: 1.8rem;
    color: #f0db4f;
    margin-bottom: 20px;
}

#reportFilters {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.table {
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
}

#adminModal {
    filter: none;
	background: #fff;
    pointer-events: auto;
    z-index: 2000;
}

.feedback-message {
    position: fixed;
	bottom: calc(60px + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(50, 50, 50, 0.9);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    font-size: 1rem;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
    z-index: 1500;
    animation: feedbackAppear 0.3s ease-out, feedbackDisappear 0.5s ease-in 4.5s;
}

.feedback-message.success {
    background: rgba(34, 139, 34, 0.9);
}

.feedback-message.error {
    background: rgba(178, 34, 34, 0.9);
}

.feedback-message:before {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid rgba(50, 50, 50, 0.9);
}

.feedback-message.success:before {
    border-top-color: rgba(34, 139, 34, 0.9);
}

.feedback-message.error:before {
    border-top-color: rgba(178, 34, 34, 0.9);
}

/* Efekt */
@keyframes feedbackAppear {
    0% {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
    100% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes feedbackDisappear {
    0% {
        opacity: 1;
    }
    100% {
        opacity: 0;
    }
}


.feedback-message::after {
    content: '';
    display: block;
    position: absolute;
    bottom: 0;
    left: 0;
    height: 4px;
    background: rgba(255, 255, 255, 0.7);
    animation: progressBar 5s linear forwards;
}

@keyframes progressBar {
    0% {
        width: 100%;
        background-color: rgba(50, 205, 50, 0.9);
    }
    100% {
        width: 0;
        background-color: rgba(255, 69, 0, 0.9);
    }
}


.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #4D148C, #FF6600);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    transition: opacity 1s ease-out;
}

.loading-screen.fade-out {
    opacity: 0;
}



.toolbar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 100;
    visibility: hidden;
    opacity: 0;
    display: flex;
    justify-content: space-evenly;
    align-items: center;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(77, 20, 140, 0.9));
    border-top: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.3);
    padding: 8px 0;
    border-radius: 12px 12px 0 0;
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out, transform 0.3s ease-in-out;
    transform: translateY(100%);
}

.toolbar.active {
    visibility: visible;
    opacity: 1;
    transform: translateY(0);
}

.toolbar-item {
    flex: 0 1 70px;
    text-align: center;
    font-size: 0.8rem;
    color: #ffffff;
    cursor: pointer;
    transition: transform 0.2s ease, background-color 0.3s ease, color 0.3s ease;
    padding: 5px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
}

.toolbar-item:hover {
    transform: scale(1.1);
    background: rgba(255, 102, 0, 0.8);
    color: #ffffff;
    box-shadow: 0 4px 8px rgba(255, 102, 0, 0.4);
}

.toolbar-item:active {
    transform: scale(0.95);
    background: rgba(255, 102, 0, 0.6);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}

.toolbar-item i {
    font-size: 1.4rem;
    margin-bottom: 5px;
}

.toolbar-item span {
    font-size: 0.8rem;
}

.status-indicator {
    display: inline-block;
    width: 15px;
    height: 15px;
    border-radius: 50%;
}

.status-online {
    background: #12db22;
}

.status-offline {
    background: #de370d;
}

.fedex-logo {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 100px;
    height: auto;
    filter: drop-shadow(0px 4px 6px rgba(0, 0, 0, 0.5));
    transition: transform 0.3s ease;
}

.fedex-logo:hover {
    transform: scale(1.1);
}

.fullscreen-report {
    visibility: hidden;
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #24292e, #0366d6);
    color: #fefefe;
    z-index: 3000;
    padding: 20px;
    transition: visibility 0.3s ease-in-out;
}

.fullscreen-report.open {
    visibility: visible;
}

@media (max-width: 768px) {
    .flip-card {
        width: 95%;
        max-width: 100%;
    }

    .info-grid {
        flex-direction: column;
        align-items: center;
    }

    .info-card {
        width: 100%;
        max-width: 100%;
        padding: 15px;
    }

    .fullscreen-report {
        padding: 10px;
    }

    .toolbar {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
    }

    .toolbar-item {
        flex-basis: 45%;
        margin-bottom: 10px;
        text-align: center;
    }

    .toolbar-item i {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .toolbar-item span {
        display: block;
        font-size: 0.8rem;
    }
}

@media (orientation: landscape) {
    .container {
        flex-direction: row;
        justify-content: space-evenly;
        align-items: center;
    }

    .info-card {
        max-width: 200px;
    }
}



@media (max-width: 480px) {
    .info-grid {
        flex-direction: column;
        align-items: center;
    }

    .info-card {
        width: 100%;
        padding: 15px;
    }
    .toolbar {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
    }

    .toolbar-item {
        flex-basis: 45%;
        margin-bottom: 10px;
        text-align: center;
    }

    .toolbar-item i {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .toolbar-item span {
        display: block;
        font-size: 0.8rem;
    }
}

.rotate-warning {
    position: fixed;
    bottom: calc(120px + 40px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 69, 0, 0.9);
    color: #fff;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 0.9rem;
    z-index: 9999;
    display: none;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.rotate-warning.active {
    display: block;
}




.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    background: #f4f4f4;
    border-radius: 8px;
    padding: 10px;
}

.custom-table th, .custom-table td {
    color: white;
}

.custom-table tr:nth-child(even) {
    background: #f9f9f9;
}

.custom-table thead {
    background: #4D148C;
    color: white;
}


.custom-table th, .custom-table td {
    color: #333;
}

.custom-table td {
    padding: 8px;
}

.custom-table thead {
    background: #4D148C;
    color: white;
}

.custom-table tr:hover {
    background: #FF6600;
    color: white;
}

.filter-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.filter-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    justify-content: center;
}

.filter-input, .filter-select {
    padding: 8px;
    font-size: 1rem;
}

.status-up {
    color: lightgreen;
    font-weight: bold;
}

.status-down {
    color: red;
    font-weight: bold;
}


/* Verisiz durum */
.no-data {
    text-align: center;
    font-size: 1rem;
    color: #999;
    margin: 15px 0;
}

.no-data i {
    font-size: 1.5rem;
    color: #FF6600;
    margin-bottom: 5px;
}

#closeTableIcon {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 2.5rem;
    color: #333333;
    cursor: pointer;
    z-index: 3000;
    transition: transform 0.2s ease, color 0.2s ease;
}

#closeTableIcon:hover {
    color: #555555;
    transform: scale(1.2);
}



/* Close button */
.close-button {
    font-size: 1.2rem;
    color: #FF6600;
    cursor: pointer;
    margin-left: 10px;
    transition: transform 0.3s ease, color 0.3s ease;
}

.close-button:hover {
    color: #FF4500;
    transform: scale(1.2);
}

.report-header {
    text-align: center;
    position: relative;
    margin-bottom: 20px;
    color: #4D148C;
    background: linear-gradient(135deg, #FF6600, #FFD700);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.device-name {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
    color: #fff;
}

@keyframes shine {
    0% {
        background-position: -200px 0;
    }
    100% {
        background-position: 200px 0;
    }
}

.fade-out {
    animation: fadeOut 1s ease-out forwards;
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}


    </style>
</head>
<body>

	<!-- Switch Icon -->
<i class="fas fa-sitemap switch-icon" id="switchIcon" title="Switch Paneli"
   role="button" aria-label="Switch Paneli" tabindex="0"></i>

<i class="fas fa-user-shield admin-icon" id="adminIcon" title="Admin Paneli"
   role="button" aria-label="Admin Paneli" tabindex="0"></i>

<i class="fas fa-copy copy-icon" id="copyIcon" title="Bilgileri Kopyala"
   role="button" aria-label="Bilgileri Kopyala" tabindex="0"></i>


<!-- Modal Overlay -->
<div class="modal-overlay" id="modalOverlay"></div>


<div class="container">
        <div id="flipCard" class="flip-card">
            <div class="flip-card-inner">
                <!-- Ön Yüz -->
                <div class="flip-card-front">
                    <h2>Cihaz Bilgileri</h2>
                    <div id="basicDeviceInfo" class="info-grid">
                        <!-- Data kartları buraya gelecek -->
                    </div>
                </div>
                <!-- Arka Yüz -->
                <div class="flip-card-back">
                    <h2>Admin Paneli</h2>
                    <div id="adminDeviceInfo" class="info-grid">
                        <!-- Admin dataları buraya gelecek -->
                    </div>
                </div>
            </div>
        </div>
    </div>




<div class="toolbar" id="toolbar">
    <div id="detailsButton" class="toolbar-item" onclick="toggleDetailsPanel()" tabindex="0">
        <i class="fas fa-info-circle"></i>
    </div>
    <div id="portTableButton" class="toolbar-item" onclick="openPortTable()" tabindex="0">
    <i class="fas fa-table"></i>
</div>
    <div id="logoutButton" class="toolbar-item" onclick="handleAdminLogout()" tabindex="0">
        <i class="fas fa-sign-out-alt"></i>
    </div>
</div>




<div id="rotateWarning" class="rotate-warning">
    Daha iyi bir deneyim için cihazınızı yatay moda çevirin.
</div>



<!-- Yükleme Ekranı -->
<div class="loading-screen" id="loadingScreen">
    <img src="https://tr.eu.fedex.com/fedex_logo.png" alt="FedEx Logo">
</div>


<!-- Tam Ekran Rapor -->
<div class="fullscreen-report" id="fullscreenReport">
	<i class="fas fa-times close-icon" id="closeTableIcon" title="Kapat" tabindex="0"></i>
    <div class="filter-container" style="margin-top: 40px;">
        <input type="text" id="reportSearchInput" class="filter-input"
               placeholder="Ara... (port, durum, hostname)"
               aria-label="Tablo arama" style="width: 300px; border-radius: 8px;">
        <select id="reportStatusFilter" class="filter-select"
                aria-label="Durum filtresi" style="border-radius: 8px;">
            <option value="">Tum Durumlar</option>
            <option value="up">Up</option>
            <option value="down">Down</option>
        </select>
    </div>
    <div class="report-content" id="reportContent">
        <!-- Tablo içeriği buraya gelecek -->
    </div>
</div>




<!-- Admin Modal -->
<div class="modal-container" id="adminModal" style="display:none;"
     role="dialog" aria-modal="true" aria-label="Admin Girisi">
    <span class="close-icon" onclick="document.getElementById('adminModal').style.display='none'"
          role="button" aria-label="Kapat" tabindex="0">X</span>
    <h4>Admin Girişi</h4>
    <input type="password" id="adminPassword" placeholder="Şifreyi Girin" minlength="4">
    <button class="btn btn-primary" onclick="handleAdminLogin()">Giriş Yap</button>
    <div class="warning-message">
        <i class="fas fa-exclamation-circle"></i> Bu alana sadece yetkili kullanıcılar erişebilir.
    </div>
</div>




<!-- Bootstrap and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <!-- Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
    // Dev-only logging: set to true to enable debug logs
    const DEV_MODE = false;
    function devLog(...args) {
        if (DEV_MODE) {
            console.log(...args);
        }
    }
    function devWarn(...args) {
        if (DEV_MODE) {
            console.warn(...args);
        }
    }

    let deviceData = null;
    let loginAttempts = 0;
    let adminTimeout;
    let isLockedOut = false;
	let isAdminLoggedIn = false;
	let portData = null;
	let deviceModel  = null;
	const ADMIN_TIMEOUT_DURATION = 120000;

	// Dead code removed: searchInput/statusFilter were referencing null elements

	document.getElementById("switchIcon").style.display = "block";
document.addEventListener('DOMContentLoaded', function() {
    const switchIcon = document.getElementById('switchIcon');
    if (switchIcon) {
        switchIcon.addEventListener('click', function() {
            var uid = new URLSearchParams(window.location.search).get('uid');
            window.location.href = "/Netinfo/switchDetails.html" + (uid ? "?uid=" + encodeURIComponent(uid) : "");
        });
    } else {
        devLog("Element with id 'switchIcon' not found.");
    }
});

if (!isAdminLoggedIn) {
    devLog("Toolbar is inactive as admin login has not occurred.");
}



document.getElementById('copyIcon').addEventListener('click', function () {
    const infoCards = document.querySelectorAll('.info-card');
    if (!infoCards.length) {
        showFeedback("Kopyalanacak bilgi bulunamadı.", false);
        return;
    }

    let textToCopy = Array.from(infoCards)
        .map(card => card.textContent.trim())
        .join('\n');

    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            showFeedback("Bilgiler başarıyla kopyalandı!", true);
        })
        .catch(() => {
            showFeedback("Bilgiler kopyalanamadı.", false);
        });
});




// Loading state fix: tie loading screen removal to actual data fetch
document.addEventListener('DOMContentLoaded', async function () {
    const loadingScreen = document.getElementById('loadingScreen');
    const params = new URLSearchParams(window.location.search);
    const uuid = params.get('uid');
    const basicDeviceInfoDiv = document.getElementById('basicDeviceInfo');
    const reportContentDiv = document.getElementById('reportContent');
    const switchIconEl = document.getElementById("switchIcon");
    devLog(switchIconEl);
    devLog(window.getComputedStyle(switchIconEl).display);
    devLog(window.getComputedStyle(switchIconEl).visibility);
    const supportedModels = [
        "C9300-24P",
        "C9300-48P",
        "ISR4351/K9",
        "WS-C3850-48F-E",
        "WS-C3850-24P-S",
        "C9500-24Y4C",
        "C9300L-24T-4G",
        "WS-C2960X-48FPS-L"
    ];

	devLog("Device Model:", deviceModel);

    const switchModal = document.getElementById("switchModal");

    // Loading screen: remove after data is actually loaded (not a timer)
    function hideLoadingScreen() {
        if (loadingScreen) {
            loadingScreen.classList.add('fade-out');
            loadingScreen.addEventListener('transitionend', function handler() {
                loadingScreen.style.display = 'none';
                loadingScreen.removeEventListener('transitionend', handler);
            });
            // Fallback in case transitionend doesn't fire
            setTimeout(function() {
                if (loadingScreen.style.display !== 'none') {
                    loadingScreen.style.display = 'none';
                }
            }, 1500);
        }
    }

    if (!uuid) {
        basicDeviceInfoDiv.textContent = "Cihaz UUID'si belirtilmemiş.";
        reportContentDiv.textContent = "Rapor verisi için cihaz UUID gerekli.";
        hideLoadingScreen();
        return;
    }

    // Fetch device data directly by UUID (single API call)
    deviceData = await fetchDeviceDataByUUID(uuid);
    if (deviceData) {
        displayBasicDeviceInfo(deviceData);
    } else {
        basicDeviceInfoDiv.textContent = "Cihaz verisi yüklenemedi.";
    }
    hideLoadingScreen();
});

document.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(window.location.search);
    const uuid = params.get('uid');

    if (!uuid) {
        devLog("Cihaz UUID belirtilmemiş.");
        return;
    }

    // Fetch device data directly by UUID (single API call)
    deviceData = await fetchDeviceDataByUUID(uuid);

    if (deviceData) {
        displayAdminDeviceInfo();
    } else {
        devLog("Cihaz verisi bulunamadı veya yüklenemedi.");
    }
});


// SECURITY FIX: openPortTable uses safe DOM methods instead of innerHTML
function openPortTable() {
    const modal = document.getElementById('portTableModal');
    const portTableContent = document.getElementById('portTableContent');

    const ports = deviceData.ports || [];

    // Clear existing content safely
    while (portTableContent.firstChild) {
        portTableContent.removeChild(portTableContent.firstChild);
    }

    ports.forEach(function(port) {
        var portDiv = document.createElement('div');

        var portNameP = document.createElement('p');
        portNameP.textContent = 'Port: ' + port.name;
        portDiv.appendChild(portNameP);

        var portStatusP = document.createElement('p');
        portStatusP.textContent = 'Durum: ' + port.status;
        portDiv.appendChild(portStatusP);

        portTableContent.appendChild(portDiv);
    });

    modal.style.display = 'block';
}

function closePortTable() {
    document.getElementById('portTableModal').style.display = 'none';
}

function toggleDetailsPanel() {
    const flipCard = document.getElementById("flipCard");

    if (isAdminLoggedIn) {
        if (flipCard.classList.contains("admin-active")) {
            flipCard.classList.remove("admin-active");
            displayBasicDeviceInfo();
        } else {
            flipCard.classList.add("admin-active");
            displayAdminDeviceInfo();
            showToolbar();
        }
    } else {
        showFeedback("Admin oturumu başlatılmamış. Giriş yapmalısınız.", false);
        displayBasicDeviceInfo();
    }
}

const switchIcon = document.getElementById("switchIcon");





function showFeedback(message, isSuccess) {
    const feedbackContainer = document.createElement("div");
    feedbackContainer.className = "feedback-message " + (isSuccess ? "success" : "error");
    feedbackContainer.setAttribute("role", "status");
    feedbackContainer.textContent = message;

    document.body.appendChild(feedbackContainer);

    setTimeout(() => {
        feedbackContainer.remove();
    }, 5000);
}

document.getElementById("switchIcon").addEventListener("click", openSwitchModal);
document.getElementById("copyIcon").addEventListener("click", copyDeviceInfo);
document.getElementById("adminIcon").addEventListener("click", toggleAdminLogin);
document.getElementById("closeTableIcon").addEventListener("click", function () {
    const fullscreenReport = document.getElementById("fullscreenReport");
    if (fullscreenReport) {
        fullscreenReport.classList.remove("open");
        fullscreenReport.style.visibility = "hidden";
    }
    devLog("Tablo ekranı kapatıldı.");
});

async function fetchWithTimeout(url, options = {}, timeoutMs = 15000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
    try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(timeoutId);
        return response;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

async function fetchWithRetry(url, options = {}, retries = 3, timeoutMs = 15000) {
    for (var attempt = 0; attempt < retries; attempt++) {
        try {
            var response = await fetchWithTimeout(url, options, timeoutMs);
            if (response.ok) return response;
            if (response.status >= 400 && response.status < 500) {
                throw new Error("Client error: " + response.status);
            }
            if (response.status >= 500) {
                try {
                    var errorBody = await response.clone().text();
                    console.error("Server error " + response.status + " for " + url + ": " + errorBody);
                } catch (e) { /* ignore parse error */ }
            }
        } catch (error) {
            if (attempt === retries - 1) throw error;
            var delay = Math.pow(2, attempt) * 1000;
            devLog("Fetch attempt " + (attempt + 1) + " failed, retrying in " + delay + "ms...");
            await new Promise(function(resolve) { setTimeout(resolve, delay); });
        }
    }
    throw new Error("All fetch attempts failed");
}

async function fetchDeviceDataByUUID(uuid) {
   if (!uuid) {
       devLog("UUID is required.");
       return null;
   }

   var url = "/Netinfo/api/device/get_device_info?uid=" + encodeURIComponent(uuid);
   try {
       var response = await fetchWithRetry(url);
       return await response.json();
   } catch (error) {
       devLog("Error fetching device data for UUID " + uuid + ": " + error.message);
       return null;
   }
}

async function fetchDeviceData(id) {
   if (!id) {
       devLog("ID is required.");
       return null;
   }

   var url = "/Netinfo/api/device/get_device_info?id=" + id;
   try {
       var response = await fetchWithRetry(url);
       return await response.json();
   } catch (error) {
       devLog("Error fetching device data for ID " + id + ": " + error.message);
       return null;
   }
}



async function getDeviceDataAsync(id) {
   const deviceData = await fetchDeviceData(id);
   if (deviceData) {
       displayBasicDeviceInfo(deviceData);
   }
}




function checkOrientationAndWarn() {
    const rotateWarning = document.getElementById('rotateWarning');
    if (window.matchMedia("(orientation: portrait)").matches) {
        rotateWarning.classList.add('active');
    } else {
        rotateWarning.classList.remove('active');
    }
}

// Ekran yönü değiştiğinde kontrol et
window.addEventListener('resize', checkOrientationAndWarn);
document.addEventListener('DOMContentLoaded', checkOrientationAndWarn);




function displayBasicDeviceInfo(device) {
    const basicDeviceInfoDiv = document.getElementById('basicDeviceInfo');

    while (basicDeviceInfoDiv.firstChild) {
        basicDeviceInfoDiv.removeChild(basicDeviceInfoDiv.firstChild);
    }

    if (!device) return;

    var fields = [
        { icon: 'fa-server', label: 'Hostname', value: device.hostname },
        { icon: 'fa-network-wired', label: 'IP Adresi', value: device.ipaddress },
        { icon: 'fa-microchip', label: 'Model', value: device.model },
        { icon: 'fa-signal', label: 'Durum', value: device.ping_state || device.status, isStatus: true },
        { icon: 'fa-clock', label: 'Uptime', value: device.uptime },
        { icon: 'fa-map-marker-alt', label: 'Lokasyon', value: device.location || device.sysLocation }
    ];

    fields.forEach(function(f) {
        if (!f.value) return;
        var card = document.createElement('div');
        card.className = 'info-card';
        var iconEl = document.createElement('i');
        iconEl.className = 'fas ' + f.icon;
        card.appendChild(iconEl);
        var p = document.createElement('p');
        var strong = document.createElement('strong');
        strong.textContent = f.label + ': ';
        p.appendChild(strong);
        p.appendChild(document.createTextNode(f.value));
        if (f.isStatus) {
            var statusSpan = document.createElement('span');
            var isUp = (f.value || '').toLowerCase() === 'up' || (f.value || '').toLowerCase() === 'online';
            statusSpan.className = 'status-indicator ' + (isUp ? 'status-online' : 'status-offline');
            statusSpan.setAttribute('role', 'status');
            p.appendChild(document.createTextNode(' '));
            p.appendChild(statusSpan);
        }
        card.appendChild(p);
        basicDeviceInfoDiv.appendChild(card);
    });
}

// SECURITY FIX: displayAdminDeviceInfo uses safe DOM methods instead of innerHTML
function displayAdminDeviceInfo() {
    const adminDeviceInfoDiv = document.getElementById('adminDeviceInfo');
    if (!adminDeviceInfoDiv) {
        devLog("adminDeviceInfo öğesi bulunamadı.");
        return;
    }

    if (!deviceData) {
        devLog("Cihaz verisi bulunamadı.");
        // SECURITY FIX: use textContent instead of innerHTML
        adminDeviceInfoDiv.textContent = 'Cihaz verisi yüklenemedi.';
        return;
    }

    // SECURITY FIX: use textContent = '' instead of innerHTML = ''
    adminDeviceInfoDiv.textContent = '';

    const adminFields = [
        { field: "hostname", label: "Hostname", icon: "fa-server" },
        { field: "serial", label: "Serial", icon: "fa-barcode" },
        { field: "ipaddress", label: "IP Adresi", icon: "fa-network-wired" },
        { field: "model", label: "Model", icon: "fa-microchip" },
        { field: "uptime", label: "Uptime", icon: "fa-clock" }
    ];

    adminFields.forEach(function(item) {
        if (deviceData[item.field] !== undefined) {
            // SECURITY FIX: use createElement/textContent instead of innerHTML
            var card = document.createElement('div');
            card.className = 'info-card';

            var iconEl = document.createElement('i');
            iconEl.className = 'fas ' + item.icon;
            card.appendChild(iconEl);

            var pEl = document.createElement('p');
            var strongEl = document.createElement('strong');
            strongEl.textContent = item.label + ':';
            pEl.appendChild(strongEl);
            pEl.appendChild(document.createTextNode(' ' + deviceData[item.field]));
            card.appendChild(pEl);

            adminDeviceInfoDiv.appendChild(card);
        } else {
            devWarn(item.label + " alanı eksik.");
        }
    });
}



function closeSwitchModal() {
    const modal = document.getElementById("switchModal");
    modal.style.opacity = "0";
    setTimeout(() => {
        modal.style.display = "none";
        modal.style.opacity = "1";
    }, 300);
}




function closeAdminModal() {
    const modal = document.getElementById('adminModal');
    modal.style.display = 'none';
    modal.removeAttribute('data-target');
}

// SECURITY FIX: openSwitchModal uses DOMParser to safely parse fetched HTML
async function openSwitchModal() {
    const modal = document.getElementById('switchModal');
    const switchDetails = document.getElementById('switchDetails');

    try {
        const response = await fetch('/Netinfo/switchdetails.html');
        if (!response.ok) throw new Error("Hata: " + response.status);

        const data = await response.text();

        // SECURITY FIX: Use DOMParser to safely parse HTML instead of innerHTML
        var parser = new DOMParser();
        var doc = parser.parseFromString(data, 'text/html');

        // Clear existing content safely
        while (switchDetails.firstChild) {
            switchDetails.removeChild(switchDetails.firstChild);
        }

        // Move parsed nodes into the container
        while (doc.body.firstChild) {
            switchDetails.appendChild(doc.body.firstChild);
        }
    } catch (error) {
        // SECURITY FIX: use textContent instead of innerHTML for error message
        switchDetails.textContent = 'Veri yüklenemedi: ' + error.message;
    }

    modal.style.display = 'block';
}




    function flipCard() {
        document.getElementById("flipCard").classList.toggle("admin-active");
        document.getElementById("fetchReportButton").classList.toggle("d-block");
    }





function logAdminActivity(type, message) {
    fetch('/Netinfo/api/log/admin_activity', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            activity: type,
            message: message,
            timestamp: new Date().toISOString(),
        }),
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                devLog("Log gönderim hatası:", err);
            });
        }
        devLog("Log başarıyla kaydedildi.");
    })
    .catch(err => devLog("Log gönderim sırasında hata oluştu:", err));
}

function showToolbar() {
    const toolbar = document.getElementById('toolbar');
    if (toolbar) {
        toolbar.classList.add('active');
        toolbar.style.visibility = 'visible';
        toolbar.style.opacity = '1';
    }
}

function hideToolbar() {
    const toolbar = document.getElementById('toolbar');
    if (toolbar) {
        toolbar.classList.remove('active');
        toolbar.style.visibility = 'hidden';
        toolbar.style.opacity = '0';
    }
}



function toggleAdminLogin() {
    const adminModal = document.getElementById("adminModal");
    if (!adminModal) {
        devLog("Admin modal öğesi bulunamadı.");
        return;
    }
    adminModal.style.display = "block";
    // USABILITY FIX: autofocus password input when modal opens
    var passwordInput = document.getElementById('adminPassword');
    if (passwordInput) {
        passwordInput.value = '';
        setTimeout(function() { passwordInput.focus(); }, 100);
    }
    devLog("Admin modal açıldı.");
}




document.addEventListener("DOMContentLoaded", () => {
    if (isAdminLoggedIn) {
        showToolbar();
    } else {
        hideToolbar();
    }
});


function checkToolbarState() {
    const toolbar = document.getElementById("toolbar");
    if (toolbar) {
        const toolbarStyle = window.getComputedStyle(toolbar);
        devLog("Toolbar durumu - Display: " + toolbarStyle.display + ", Opacity: " + toolbarStyle.opacity);
    } else {
        devLog("Toolbar öğesi bulunamadı.");
    }
}


function setAdminLoggedIn(status) {
    isAdminLoggedIn = status;
    devLog("isAdminLoggedIn durumu değişti: " + status);
}




function closeReportPanel() {
    const fullscreenReport = document.getElementById('fullscreenReport');
    fullscreenReport.classList.remove('open');
    setTimeout(() => {
        fullscreenReport.style.visibility = 'hidden';
    }, 500);
}

// Responsive design handled via CSS media queries (no JS scale hacks)





function formatFieldName(fieldName) {
    return fieldName
        .replace(/_/g, ' ')
        .replace(/\b\w/g, char => char.toUpperCase());
}

async function fetchAdminInfo() {
    try {
        const response = await fetch('/Netinfo/api/device/get_admin_info');
        if (!response.ok) {
            throw new Error("HTTP error! Status: " + response.status);
        }
        const adminData = await response.json();
        devLog("Admin API Yanıtı:", adminData);
        deviceData = adminData;
        displayAdminDeviceInfo();
        devLog("Admin verileri (deviceData):", deviceData);

    } catch (error) {
        devLog("Admin bilgileri yüklenirken hata:", error.message);
    }
}




async function checkAdminPassword() {
    const passwordInput = document.getElementById('adminPassword');
    if (!passwordInput) {
        devLog("adminPassword öğesi bulunamadı.");
        showFeedback("Şifre alanı eksik. Lütfen yeniden yükleyin.", false);
        return;
    }

    const passwordValue = passwordInput.value;
    if (!passwordValue) {
        showFeedback("Şifre alanı boş bırakılamaz.", false);
        return;
    }

    try {
        const response = await fetch('/Netinfo/api/environment/validate_admin_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: passwordValue }),
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error("Sunucu hatası: " + response.status + ", Detay: " + errorText);
        }

        const result = await response.json();
        devLog("Backend'den gelen cevap:", result);

        if (result.success) {
            handleSuccessfulAdminLogin();
        } else {
            handleFailedAdminLogin();
        }
    } catch (error) {
        devLog("Şifre doğrulama sırasında bir hata oluştu:", error.message);
        showFeedback("Bir hata oluştu: " + error.message, false);
    }
}


const toolbar = document.getElementById("toolbar");

devLog("Toolbar sınıf listesi:", toolbar.classList);
devLog("Toolbar CSS durumu:", window.getComputedStyle(toolbar).display);

const flipCardInner = document.querySelector('.flip-card-inner');
devLog(window.getComputedStyle(flipCardInner).transform);



function handleSuccessfulAdminLogin() {
    isAdminLoggedIn = true;
    showToolbar();
    showFeedback("Admin girişi başarılı!", true);
}




function handleFailedAdminLogin() {
    loginAttempts++;
    const passwordInput = document.getElementById('adminPassword');
    if (passwordInput) passwordInput.value = "";

    const feedbackMessage = loginAttempts >= 3
        ? "Çok fazla hatalı giriş yaptınız. 10 dakika bekleyin."
        : "Hatalı şifre, lütfen tekrar deneyiniz.";

    showFeedback(feedbackMessage, false);

    if (loginAttempts >= 3) {
        isLockedOut = true;
        setTimeout(() => {
            isLockedOut = false;
            loginAttempts = 0;
            showFeedback("Hatalı giriş süresi doldu. Yeniden deneyebilirsiniz.", true);
        }, 600000);
    }
}

async function handleAdminLogin() {
    const passwordInput = document.getElementById('adminPassword');
    if (!passwordInput) {
        devLog("Şifre girişi alanı bulunamadı.");
        showFeedback("Bir hata oluştu. Lütfen yeniden deneyin.", false);
        return;
    }

    const password = passwordInput.value;
    if (!password) {
        showFeedback("Şifre alanı boş bırakılamaz.", false);
        return;
    }

    try {
        const response = await fetch('/Netinfo/api/environment/validate_admin_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password }),
        });

        const result = await response.json();
        if (result.success) {
            isAdminLoggedIn = true;
            showToolbar();
            document.getElementById('adminModal').style.display = 'none';
            showFeedback("Admin oturumu başladı!", true);
        } else {
            // USABILITY FIX: use showFeedback instead of alert
            showFeedback("Hatalı şifre, tekrar deneyiniz.", false);
        }
    } catch (error) {
        devLog("Şifre doğrulama hatası:", error.message);
        showFeedback("Bir hata oluştu: " + error.message, false);
    }
}


function handleAdminLogout() {
    isAdminLoggedIn = false;
    hideToolbar();

    const flipCard = document.getElementById("flipCard");
    if (flipCard) {
        flipCard.classList.remove("admin-active");
        devLog("Admin çıkışı yapıldı, basic info sayfası gösteriliyor.");
    }

    showFeedback("Admin oturumu sona erdi.", true);
}



function showAdminModal() {
    if (isAdminLoggedIn) {
		showToolbar();
        toggleDetailsPanel();
    } else {
        const adminModal = document.getElementById('adminModal');
        adminModal.style.display = 'block';
        // USABILITY FIX: autofocus password input
        var passwordInput = document.getElementById('adminPassword');
        if (passwordInput) {
            passwordInput.value = '';
            setTimeout(function() { passwordInput.focus(); }, 100);
        }
    }
}



function startAdminTimeout() {
    clearTimeout(adminTimeout);
    adminTimeout = setTimeout(() => {
        isAdminLoggedIn = false;
        showFeedback("Admin oturum süresi sona erdi. Yeniden giriş yapmalısınız.", false);
    }, ADMIN_TIMEOUT_DURATION);
}



function showTimeoutWarning() {
    const warning = document.createElement("div");
    warning.className = "feedback-message error";
    warning.setAttribute("role", "status");
    warning.textContent = "Admin oturum süresi doldu. Yeniden giriş yapmalısınız.";
    document.body.appendChild(warning);

    setTimeout(() => warning.remove(), 5000);
}




function handleEnterKey(event) {
        if (event.key === "Enter") {
            checkAdminPassword();
        }
    }

// Search/filter functionality for report tables
(function() {
    var searchInput = document.getElementById('reportSearchInput');
    var statusFilter = document.getElementById('reportStatusFilter');

    function filterReportTable() {
        var reportContent = document.getElementById('reportContent');
        if (!reportContent) return;

        var rows = reportContent.querySelectorAll('table tbody tr, div.port-row');
        if (!rows.length) {
            rows = reportContent.querySelectorAll('div > div');
        }

        var searchTerm = (searchInput ? searchInput.value : '').toLowerCase();
        var statusValue = (statusFilter ? statusFilter.value : '').toLowerCase();

        rows.forEach(function(row) {
            var text = row.textContent.toLowerCase();
            var matchesSearch = !searchTerm || text.indexOf(searchTerm) !== -1;
            var matchesStatus = !statusValue || text.indexOf(statusValue) !== -1;
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }

    if (searchInput) {
        searchInput.addEventListener('input', filterReportTable);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterReportTable);
    }
})();

function copyDeviceInfo() {
    const flipCard = document.getElementById("flipCard");
    const isAdminActive = flipCard.classList.contains("admin-active");

    const elementId = isAdminActive ? "adminDeviceInfo" : "basicDeviceInfo";
    const infoElement = document.getElementById(elementId);

    if (!infoElement || !infoElement.children.length) {
        showFeedback("Kopyalanacak bilgi bulunamadı.", false);
        return;
    }

    let textToCopy = Array.from(infoElement.querySelectorAll(".info-card"))
        .map(card => card.textContent.trim())
        .join("\n");

    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            showFeedback("Bilgiler başarıyla kopyalandı!", true);
        })
        .catch(() => {
            showFeedback("Bilgiler kopyalanamadı.", false);
        });
}

</script>


</body>
</html>
